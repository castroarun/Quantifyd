//@version=5
strategy("CC - OTM 2% + RSI(30-60) + Stop Loss",
         overlay=true,
         initial_capital=1000000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.percent,
         commission_value=0.03,
         slippage=0,
         calc_on_every_tick=false)

// ============================================
// STRATEGY: OTM_2PCT + RSI(30-60) + STOP_LOSS
// TOP PERFORMER: 29.07% Return | 88.2% Win Rate
// Sharpe: 1.69 | Max DD: 4.92%
// ============================================

// === INPUTS ===
grp1 = "RSI Filter"
rsiLength = input.int(14, "RSI Length", minval=1, group=grp1)
rsiMin = input.int(30, "RSI Min (Entry)", minval=10, maxval=50, group=grp1)
rsiMax = input.int(60, "RSI Max (Entry)", minval=40, maxval=80, group=grp1)

grp2 = "Covered Call"
otmPercent = input.float(2.0, "OTM %", minval=1, maxval=10, step=0.5, group=grp2)
premiumPct = input.float(2.0, "Premium % (of stock)", minval=0.5, maxval=5.0, group=grp2)

grp3 = "Exit Rules"
stopLossMultiple = input.float(2.0, "Stop Loss (x premium)", minval=1.0, maxval=3.0, step=0.5, group=grp3)
stopLossPct = input.float(5.0, "Stop Loss % (of entry)", minval=2.0, maxval=10.0, step=0.5, group=grp3)
usePercentSL = input.bool(true, "Use % Stop Loss (vs premium multiple)", group=grp3)
profitTargetPct = input.float(50.0, "Profit Target %", minval=10, maxval=90, group=grp3)
maxDays = input.int(30, "Max Holding Days", minval=7, maxval=60, group=grp3)
allowSLAdjust = input.bool(true, "Allow SL Adjustment (Roll-up)", group=grp3)
cooldownBars = input.int(5, "Cooldown Bars After Exit", minval=1, maxval=20, group=grp3)

// === CALCULATIONS ===
rsiVal = ta.rsi(close, rsiLength)
rsiInZone = rsiVal >= rsiMin and rsiVal <= rsiMax
rsiWasBelow = rsiVal[1] < rsiMin
rsiWasAbove = rsiVal[1] > rsiMax

// RSI just entered the zone (cross into 30-60 from outside)
rsiEnteredZone = rsiInZone and (rsiWasBelow or rsiWasAbove)

// Strike price (2% OTM)
dynamicStrike = close * (1 + otmPercent / 100)

// === POSITION TRACKING ===
var float entryPrice = na
var float strikePrice = na
var float premium = na
var float stopLossPrice = na
var float initialSL = na
var int entryBar = na
var int lastExitBar = 0

// === ENTRY CONDITION ===
// RSI crosses INTO 30-60 zone (momentum building signal)
// Only enter when RSI moves from oversold (<30) or overbought (>60) into the zone
// Plus: Must wait for cooldown period after last exit
barsSinceExit = bar_index - lastExitBar
cooldownPassed = barsSinceExit >= cooldownBars

canEnter = rsiEnteredZone and cooldownPassed
enterLong = canEnter and strategy.position_size == 0

if enterLong
    entryPrice := close
    strikePrice := dynamicStrike
    premium := close * premiumPct / 100
    // Use either % based SL or premium multiple SL
    stopLossPrice := usePercentSL ? entryPrice * (1 - stopLossPct / 100) : entryPrice - (premium * stopLossMultiple)
    initialSL := stopLossPrice
    entryBar := bar_index
    strategy.entry("CC", strategy.long)

// === EXIT CONDITIONS ===
inPosition = strategy.position_size > 0
barsHeld = bar_index - entryBar

// P&L Calculation (Covered Call)
stockPnL = inPosition ? (close - entryPrice) : 0
callPayoff = inPosition ? (close >= strikePrice ? -(close - strikePrice) : 0) : 0
totalPnL = stockPnL + premium + callPayoff

// SL Adjustment (Roll-up) - Move SL up as position profits
if inPosition and allowSLAdjust
    // If stock has gained significantly, raise stop loss
    unrealizedProfit = close - entryPrice
    if unrealizedProfit > premium  // Stock up more than premium
        newSL = entryPrice + (unrealizedProfit * 0.5)  // Lock in 50% of gains
        if newSL > stopLossPrice
            stopLossPrice := newSL

// Exit conditions
profitTarget = inPosition and totalPnL >= (premium * profitTargetPct / 100)
hitStopLoss = inPosition and close < stopLossPrice
timeExit = inPosition and barsHeld >= maxDays
strikeHit = inPosition and close >= strikePrice

exitLong = profitTarget or hitStopLoss or timeExit or strikeHit

// Determine exit reason
var string exitReason = ""
if exitLong
    exitReason := profitTarget ? "PT" : strikeHit ? "STRIKE" : hitStopLoss ? "SL" : "DTE"
    lastExitBar := bar_index  // Track exit bar for cooldown
    strategy.close("CC", comment=exitReason)

// === VISUALIZATION ===
// RSI Zone indicator
rsiColor = rsiInZone ? color.green : (rsiVal > rsiMax ? color.red : color.orange)

// Position levels
plot(inPosition ? strikePrice : na, "Strike (2% OTM)", color.blue, 2, plot.style_circles)
plot(inPosition ? stopLossPrice : na, "Stop Loss", color.red, 1, plot.style_linebr)
plot(inPosition ? entryPrice : na, "Entry", color.yellow, 1, plot.style_linebr)
plot(inPosition ? initialSL : na, "Initial SL", color.new(color.red, 70), 1, plot.style_linebr)

// Entry/Exit markers
plotshape(enterLong, "ENTRY", shape.triangleup, location.belowbar, color.green, size=size.small, text="CC")
plotshape(profitTarget, "PT", shape.flag, location.abovebar, color.lime, size=size.small, text="PT")
plotshape(strikeHit and not profitTarget, "STRIKE", shape.xcross, location.abovebar, color.blue, size=size.small, text="STK")
plotshape(hitStopLoss and not profitTarget and not strikeHit, "SL", shape.triangledown, location.abovebar, color.red, size=size.small, text="SL")
plotshape(timeExit and not profitTarget and not strikeHit and not hitStopLoss, "DTE", shape.diamond, location.abovebar, color.orange, size=size.small, text="DTE")

// Background
bgcolor(inPosition ? color.new(color.green, 95) : na)
bgcolor(rsiInZone and not inPosition ? color.new(color.blue, 95) : na, title="RSI Zone Ready")

// === INFO TABLE ===
var table t = table.new(position.top_right, 2, 9, bgcolor=color.new(#1e1e1e, 20), frame_color=color.gray)
if barstate.islast
    table.cell(t, 0, 0, "RSI", text_color=color.white)
    table.cell(t, 1, 0, str.tostring(rsiVal, "#.#"), text_color=rsiColor)
    table.cell(t, 0, 1, "RSI Zone", text_color=color.white)
    table.cell(t, 1, 1, rsiInZone ? "IN (30-60)" : rsiVal > rsiMax ? "HIGH" : "LOW",
               text_color=rsiInZone ? color.green : color.red)
    table.cell(t, 0, 2, "Signal", text_color=color.white)
    signalText = not cooldownPassed ? "COOLDOWN" : rsiEnteredZone and not inPosition ? "ENTRY!" : inPosition ? "IN TRADE" : rsiInZone ? "IN ZONE" : "WAIT"
    signalColor = not cooldownPassed ? color.orange : rsiEnteredZone ? color.lime : inPosition ? color.green : rsiInZone ? color.yellow : color.gray
    table.cell(t, 1, 2, signalText, text_color=signalColor)
    table.cell(t, 0, 3, "Strike", text_color=color.white)
    table.cell(t, 1, 3, inPosition ? str.tostring(strikePrice, "#.##") : str.tostring(dynamicStrike, "#.##"),
               text_color=color.blue)
    table.cell(t, 0, 4, "OTM %", text_color=color.white)
    table.cell(t, 1, 4, str.tostring(otmPercent, "#.#") + "%", text_color=color.yellow)
    table.cell(t, 0, 5, "P&L", text_color=color.white)
    table.cell(t, 1, 5, inPosition ? str.tostring(totalPnL, "#.##") : "-",
               text_color=totalPnL > 0 ? color.green : color.red)
    table.cell(t, 0, 6, "Stop Loss", text_color=color.white)
    table.cell(t, 1, 6, inPosition ? str.tostring(stopLossPrice, "#.##") : "-", text_color=color.red)
    table.cell(t, 0, 7, "Days", text_color=color.white)
    table.cell(t, 1, 7, inPosition ? str.tostring(barsHeld) : "-", text_color=color.white)
    table.cell(t, 0, 8, "Strategy", text_color=color.white)
    table.cell(t, 1, 8, "TOP RETURN", text_color=color.lime)

// === ALERTS ===
alertcondition(enterLong,
               "Covered Call Entry - RSI Zone",
               "ENTRY: RSI in 30-60 zone. Buy stock, Sell Call at 2% OTM")

alertcondition(hitStopLoss,
               "Stop Loss Hit",
               "EXIT: Stop loss triggered - Close covered call position")

alertcondition(profitTarget,
               "Profit Target Hit",
               "EXIT: Profit target reached - Close position")

//@version=5
strategy("Covered Call - ATR Strike + VWAP",
         overlay=true,
         initial_capital=1000000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=1)

// ============================================
// STRATEGY: ATR_BASED Strike + VWAP Above
// Backtest Results: 13.17% Return | 2.50% Max DD (Best Risk-Adjusted)
// ============================================

// === INPUT PARAMETERS ===
// ATR Settings (for dynamic strike)
atrLength = input.int(14, "ATR Length", minval=1, group="ATR Strike")
atrMultiplier = input.float(1.5, "ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, group="ATR Strike")

// VWAP Settings
vwapSource = input.source(hlc3, "VWAP Source", group="VWAP")

// Covered Call Settings
holdingDays = input.int(30, "Max Holding Days (DTE)", minval=7, maxval=45, group="Covered Call")
profitTargetPct = input.float(50.0, "Profit Target %", minval=10, maxval=90, group="Exit Rules")

// Premium estimation (simplified)
premiumPct = input.float(2.5, "Estimated Premium % of Stock", minval=0.5, maxval=5.0, group="Premium")

// === ATR CALCULATION ===
atrValue = ta.atr(atrLength)
dynamicStrike = close + (atrValue * atrMultiplier)
otmPercent = ((dynamicStrike - close) / close) * 100

// === VWAP CALCULATION ===
vwapValue = ta.vwap(vwapSource)
priceAboveVwap = close > vwapValue
priceBelowVwap = close < vwapValue

// === ENTRY CONDITIONS ===
// Enter when price is above VWAP (institutional support)
entryCondition = priceAboveVwap and not priceAboveVwap[1]  // First bar crossing above

// Can also enter if continuously above VWAP and no position
entryConditionContinuous = priceAboveVwap and strategy.position_size == 0

// === TRACKING VARIABLES ===
var float entryPrice = na
var float strikePrice = na
var float premiumReceived = na
var float profitTargetPrice = na
var int entryBar = na

// Entry Logic - Only on fresh crossover
if entryCondition and strategy.position_size == 0
    entryPrice := close
    strikePrice := dynamicStrike
    premiumReceived := close * (premiumPct / 100)
    profitTargetPrice := entryPrice + (premiumReceived * profitTargetPct / 100)
    entryBar := bar_index
    strategy.entry("Covered Call", strategy.long)

// === EXIT CONDITIONS ===
// 1. Profit Target: Stock appreciated + premium decay
// 2. VWAP Break: Price drops below VWAP (loss of institutional support)
// 3. Time Exit: Holding period exceeded
// 4. Strike Breach: Stock went above strike (call would be exercised)

profitTargetHit = false
vwapBreak = false
timeExit = false
strikeBreach = false

if strategy.position_size > 0
    // Profit target - simplified: close at 50% of premium captured
    profitTargetHit := close >= profitTargetPrice

    // VWAP breakdown exit
    vwapBreak := priceBelowVwap

    // Time exit
    timeExit := (bar_index - entryBar) >= holdingDays

    // Strike breach (stock above strike = call exercised)
    strikeBreach := close >= strikePrice

// Exit Logic
exitCondition = profitTargetHit or vwapBreak or timeExit or strikeBreach

if exitCondition and strategy.position_size > 0
    exitReason = profitTargetHit ? "Profit Target" :
                 strikeBreach ? "Strike Breach" :
                 vwapBreak ? "VWAP Break" : "DTE Exit"
    strategy.close("Covered Call", comment=exitReason)

// === VISUALIZATION ===

// VWAP Line
plot(vwapValue, "VWAP", color=color.purple, linewidth=2)

// Dynamic Strike (ATR-based) - shown only when in position
strikePlot = strategy.position_size > 0 ? strikePrice : na
plot(strikePlot, "Strike (ATR-based)", color=color.blue, style=plot.style_circles, linewidth=3)

// Entry Price
entryPlot = strategy.position_size > 0 ? entryPrice : na
plot(entryPlot, "Entry Price", color=color.yellow, style=plot.style_linebr, linewidth=1)

// Profit Target Price
ptPlot = strategy.position_size > 0 ? profitTargetPrice : na
plot(ptPlot, "Profit Target", color=color.lime, style=plot.style_linebr, linewidth=1)

// ATR Bands (for reference)
upperATR = close + atrValue
lowerATR = close - atrValue
plot(upperATR, "Upper ATR", color=color.new(color.gray, 80), style=plot.style_linebr)
plot(lowerATR, "Lower ATR", color=color.new(color.gray, 80), style=plot.style_linebr)

// Entry Signal Markers
plotshape(entryCondition and strategy.position_size[1] == 0,
          "Entry Signal", shape.triangleup, location.belowbar,
          color.blue, size=size.normal, text="ENTRY")

// Exit Signal Markers
plotshape(profitTargetHit and strategy.position_size > 0,
          "Profit Target Exit", shape.flag, location.abovebar,
          color.lime, size=size.normal, text="PT")

plotshape(strikeBreach and strategy.position_size > 0 and not profitTargetHit,
          "Strike Breach", shape.xcross, location.abovebar,
          color.blue, size=size.normal, text="STRIKE")

plotshape(vwapBreak and strategy.position_size > 0 and not profitTargetHit and not strikeBreach,
          "VWAP Break Exit", shape.triangledown, location.abovebar,
          color.red, size=size.normal, text="VWAP")

plotshape(timeExit and strategy.position_size > 0 and not profitTargetHit and not strikeBreach and not vwapBreak,
          "DTE Exit", shape.diamond, location.abovebar,
          color.orange, size=size.normal, text="DTE")

// Background colors
bgcolor(strategy.position_size > 0 ? color.new(color.blue, 90) : na)
bgcolor(priceAboveVwap and strategy.position_size == 0 ? color.new(color.green, 95) : na, title="Above VWAP Zone")

// === INFO TABLE ===
var table infoTable = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "INDICATOR", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, "VALUE", text_color=color.white, bgcolor=color.gray)

    table.cell(infoTable, 0, 1, "Price vs VWAP", text_color=color.white)
    table.cell(infoTable, 1, 1, priceAboveVwap ? "ABOVE" : "BELOW",
               text_color=priceAboveVwap ? color.green : color.red)

    table.cell(infoTable, 0, 2, "VWAP", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(vwapValue, "#.##"), text_color=color.purple)

    table.cell(infoTable, 0, 3, "ATR (14)", text_color=color.white)
    table.cell(infoTable, 1, 3, str.tostring(atrValue, "#.##"), text_color=color.orange)

    table.cell(infoTable, 0, 4, "Dynamic Strike", text_color=color.white)
    table.cell(infoTable, 1, 4, str.tostring(dynamicStrike, "#.##"), text_color=color.blue)

    table.cell(infoTable, 0, 5, "OTM %", text_color=color.white)
    table.cell(infoTable, 1, 5, str.tostring(otmPercent, "#.##") + "%", text_color=color.yellow)

    table.cell(infoTable, 0, 6, "Entry Signal", text_color=color.white)
    table.cell(infoTable, 1, 6, entryCondition ? "ACTIVE" : priceAboveVwap ? "READY" : "WAIT",
               text_color=entryCondition ? color.green : priceAboveVwap ? color.yellow : color.gray)

    table.cell(infoTable, 0, 7, "Position", text_color=color.white)
    table.cell(infoTable, 1, 7, strategy.position_size > 0 ? "IN TRADE" : "FLAT",
               text_color=strategy.position_size > 0 ? color.green : color.gray)

    table.cell(infoTable, 0, 8, "Strategy", text_color=color.white)
    table.cell(infoTable, 1, 8, "LOW RISK", text_color=color.aqua)

// === ALERTS ===
alertcondition(entryCondition,
               "Covered Call Entry",
               "ENTRY: Price crossed above VWAP. Buy stock, Sell Call at ATR Strike")

alertcondition(vwapBreak and strategy.position_size > 0,
               "VWAP Break Warning",
               "EXIT: Price dropped below VWAP - Close position")

alertcondition(profitTargetHit and strategy.position_size > 0,
               "Profit Target Hit",
               "EXIT: Profit target reached - Close position")

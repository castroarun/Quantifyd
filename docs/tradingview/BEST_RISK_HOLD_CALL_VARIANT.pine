//@version=5
strategy("CC - ATR+VWAP Hold Call [VARIANT]",
         overlay=true,
         initial_capital=1000000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.percent,
         commission_value=0.03)

// ============================================
// VARIANT: Exit Stock on VWAP Break, Hold Short Call
// WARNING: Creates NAKED CALL after VWAP break!
// ============================================

// === INPUTS ===
grp1 = "ATR Strike"
atrLen = input.int(14, "ATR Length", minval=1, group=grp1)
atrMult = input.float(1.5, "ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, group=grp1)

grp2 = "Covered Call"
premiumPct = input.float(2.5, "Premium % (of stock)", minval=0.5, maxval=5.0, group=grp2)

grp3 = "Exit Rules"
profitTargetPct = input.float(50.0, "Profit Target %", minval=10, maxval=90, group=grp3)
maxDays = input.int(30, "Max Holding Days", minval=7, maxval=60, group=grp3)
nakedCallSLPct = input.float(5.0, "Naked Call SL % above strike", minval=2, maxval=15, group=grp3)

// === CALCULATIONS ===
atrVal = ta.atr(atrLen)
vwapVal = ta.vwap(hlc3)
aboveVWAP = close > vwapVal
belowVWAP = close < vwapVal
crossAboveVWAP = ta.crossover(close, vwapVal)
crossBelowVWAP = ta.crossunder(close, vwapVal)

dynamicStrike = close + (atrVal * atrMult)

// === STATE: 0=Flat, 1=Covered, 2=Naked ===
var int state = 0
var float entryPrice = na
var float strikePrice = na
var float premium = na
var int entryBar = na
var float stockExitPrice = na
var float nakedSL = na

// === ENTRY (Covered Call) ===
if crossAboveVWAP and state == 0
    entryPrice := close
    strikePrice := dynamicStrike
    premium := close * premiumPct / 100
    entryBar := bar_index
    state := 1
    strategy.entry("CC", strategy.long)

// === TRACKING ===
inCovered = state == 1
inNaked = state == 2
barsHeld = bar_index - entryBar

// P&L
stockPnL = inCovered ? (close - entryPrice) : inNaked ? (stockExitPrice - entryPrice) : 0
callLiability = (state > 0 and close >= strikePrice) ? (close - strikePrice) : 0
totalPnL = stockPnL + premium - callLiability

// === COVERED CALL EXITS ===
profitHit = inCovered and totalPnL >= (premium * profitTargetPct / 100)
timeHit = inCovered and barsHeld >= maxDays
strikeHit = inCovered and close >= strikePrice
vwapBreakExit = inCovered and crossBelowVWAP

// Standard exits (close everything)
if profitHit or timeHit or strikeHit
    strategy.close("CC", comment=profitHit ? "PT" : strikeHit ? "STRIKE" : "DTE")
    state := 0

// VWAP break -> Hold call (go naked)
if vwapBreakExit and not profitHit and not timeHit and not strikeHit
    stockExitPrice := close
    nakedSL := strikePrice * (1 + nakedCallSLPct / 100)
    strategy.close("CC", comment="VWAP-HOLD")
    state := 2

// === NAKED CALL EXITS ===
nakedSLHit = inNaked and close >= nakedSL
nakedTimeHit = inNaked and barsHeld >= maxDays
nakedStrikeHit = inNaked and close >= strikePrice

if nakedSLHit or nakedTimeHit
    // Naked call expired or hit SL
    state := 0

// === VISUALIZATION ===
plot(vwapVal, "VWAP", color.purple, 2)
plot(state > 0 ? strikePrice : na, "Strike", color.blue, 2, plot.style_circles)
plot(inCovered ? entryPrice : na, "Entry", color.yellow, 1, plot.style_linebr)
plot(inNaked ? nakedSL : na, "Naked SL", color.fuchsia, 1, plot.style_linebr)
plot(inNaked ? stockExitPrice : na, "Stock Exit", color.orange, 1, plot.style_linebr)

// Markers
plotshape(crossAboveVWAP and state[1] == 0, "ENTRY", shape.triangleup, location.belowbar, color.blue, size=size.small, text="CC")
plotshape(profitHit, "PT", shape.flag, location.abovebar, color.lime, size=size.small, text="PT")
plotshape(strikeHit and not profitHit, "STRIKE", shape.xcross, location.abovebar, color.blue, size=size.small, text="STK")
plotshape(timeHit and not profitHit and not strikeHit, "DTE", shape.diamond, location.abovebar, color.orange, size=size.small, text="DTE")
plotshape(vwapBreakExit and not profitHit and not timeHit and not strikeHit, "HOLD", shape.xcross, location.abovebar, color.purple, size=size.normal, text="HOLD\nCALL")
plotshape(nakedSLHit, "NK_SL", shape.triangledown, location.abovebar, color.fuchsia, size=size.small, text="NK_SL")

// Background
bgcolor(inCovered ? color.new(color.blue, 95) : na)
bgcolor(inNaked ? color.new(color.purple, 90) : na)

// === INFO TABLE ===
var table t = table.new(position.top_right, 2, 7, bgcolor=color.new(#1e1e1e, 20))
if barstate.islast
    stateStr = state == 0 ? "FLAT" : state == 1 ? "COVERED" : "NAKED!"
    stateCol = state == 0 ? color.gray : state == 1 ? color.green : color.fuchsia

    table.cell(t, 0, 0, "STATE", text_color=color.white)
    table.cell(t, 1, 0, stateStr, text_color=stateCol, bgcolor=state == 2 ? color.new(color.fuchsia, 70) : na)
    table.cell(t, 0, 1, "VWAP", text_color=color.white)
    table.cell(t, 1, 1, aboveVWAP ? "ABOVE" : "BELOW", text_color=aboveVWAP ? color.green : color.red)
    table.cell(t, 0, 2, "Strike", text_color=color.white)
    table.cell(t, 1, 2, state > 0 ? str.tostring(strikePrice, "#") : "-", text_color=color.blue)
    table.cell(t, 0, 3, "P&L", text_color=color.white)
    table.cell(t, 1, 3, state > 0 ? str.tostring(totalPnL, "#.##") : "-", text_color=totalPnL > 0 ? color.green : color.red)
    table.cell(t, 0, 4, "Days", text_color=color.white)
    table.cell(t, 1, 4, state > 0 ? str.tostring(barsHeld) : "-", text_color=color.white)
    table.cell(t, 0, 5, "Risk", text_color=color.white)
    table.cell(t, 1, 5, state == 2 ? "UNLIMITED!" : "LIMITED", text_color=state == 2 ? color.red : color.green)
    table.cell(t, 0, 6, "Strategy", text_color=color.white)
    table.cell(t, 1, 6, "HOLD CALL", text_color=color.aqua)

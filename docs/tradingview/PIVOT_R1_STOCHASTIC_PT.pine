//@version=5
strategy("CC - Pivot R1 + Stochastic + PT",
         overlay=true,
         initial_capital=1000000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.percent,
         commission_value=0.03,
         slippage=0,
         calc_on_every_tick=false)

// ============================================
// STRATEGY: PIVOT_R1 + Stochastic + PROFIT_TARGET
// BEST RISK-ADJUSTED: 10.35% Return | 1.98% Max DD
// Win Rate: 62.5% | Sharpe: 0.57
// ============================================

// === INPUTS ===
grp1 = "Stochastic Filter"
stochLength = input.int(14, "Stochastic Length", minval=1, group=grp1)
stochSmooth = input.int(3, "Stochastic Smoothing", minval=1, group=grp1)
stochOB = input.int(80, "Overbought Level", minval=50, maxval=95, group=grp1)

grp2 = "Pivot Points"
pivotTimeframe = input.timeframe("D", "Pivot Timeframe", group=grp2)

grp3 = "Covered Call"
premiumPct = input.float(2.0, "Premium % (of stock)", minval=0.5, maxval=5.0, group=grp3)

grp4 = "Exit Rules"
profitTargetPct = input.float(50.0, "Profit Target %", minval=10, maxval=90, group=grp4)
stopLossMultiple = input.float(2.0, "Stop Loss (x premium)", minval=1.0, maxval=3.0, group=grp4)
maxDays = input.int(30, "Max Holding Days", minval=7, maxval=60, group=grp4)
useTrailingStop = input.bool(true, "Use Trailing Stop", group=grp4)
trailActivation = input.float(25.0, "Trail Activation %", minval=10, maxval=50, group=grp4)
trailPercent = input.float(15.0, "Trail Stop %", minval=5, maxval=30, group=grp4)

// === STOCHASTIC CALCULATION ===
stochK = ta.stoch(close, high, low, stochLength)
stochD = ta.sma(stochK, stochSmooth)
stochOverbought = stochK > stochOB

// === PIVOT POINT CALCULATION ===
// Get previous day's high, low, close for pivot calculation
prevHigh = request.security(syminfo.tickerid, pivotTimeframe, high[1], barmerge.gaps_off, barmerge.lookahead_on)
prevLow = request.security(syminfo.tickerid, pivotTimeframe, low[1], barmerge.gaps_off, barmerge.lookahead_on)
prevClose = request.security(syminfo.tickerid, pivotTimeframe, close[1], barmerge.gaps_off, barmerge.lookahead_on)

// Classic Pivot Points
pivotPoint = (prevHigh + prevLow + prevClose) / 3
pivotR1 = (2 * pivotPoint) - prevLow
pivotR2 = pivotPoint + (prevHigh - prevLow)
pivotS1 = (2 * pivotPoint) - prevHigh

// === POSITION TRACKING ===
var float entryPrice = na
var float strikePrice = na
var float premium = na
var float stopLossPrice = na
var float highestPrice = na
var int entryBar = na
var bool trailActivated = false

// === ENTRY CONDITION ===
// Stochastic overbought - expecting mean reversion or sideways
canEnter = stochOverbought
enterLong = canEnter and strategy.position_size == 0

if enterLong
    entryPrice := close
    strikePrice := pivotR1  // Use Pivot R1 as strike
    premium := close * premiumPct / 100
    stopLossPrice := entryPrice - (premium * stopLossMultiple)
    highestPrice := close
    entryBar := bar_index
    trailActivated := false
    strategy.entry("CC", strategy.long)

// === EXIT CONDITIONS ===
inPosition = strategy.position_size > 0
barsHeld = bar_index - entryBar

// Track highest price for trailing stop
if inPosition and close > highestPrice
    highestPrice := close

// P&L Calculation
stockPnL = inPosition ? (close - entryPrice) : 0
callPayoff = inPosition ? (close >= strikePrice ? -(close - strikePrice) : 0) : 0
totalPnL = stockPnL + premium + callPayoff
pnlPct = inPosition ? (totalPnL / premium) * 100 : 0

// Trailing Stop Logic
if inPosition and useTrailingStop
    if pnlPct >= trailActivation
        trailActivated := true
    if trailActivated
        trailStopPrice = highestPrice * (1 - trailPercent / 100)
        if trailStopPrice > stopLossPrice
            stopLossPrice := trailStopPrice

// Exit conditions
profitTarget = inPosition and totalPnL >= (premium * profitTargetPct / 100)
hitStopLoss = inPosition and close < stopLossPrice
timeExit = inPosition and barsHeld >= maxDays
strikeHit = inPosition and close >= strikePrice

exitLong = profitTarget or hitStopLoss or timeExit or strikeHit

// Determine exit reason
var string exitReason = ""
if exitLong
    exitReason := profitTarget ? "PT" : strikeHit ? "STRIKE" : hitStopLoss ? "SL" : "DTE"
    strategy.close("CC", comment=exitReason)

// === VISUALIZATION ===
// Pivot levels
plot(pivotR1, "Pivot R1 (Strike)", color.blue, 2, plot.style_stepline)
plot(pivotR2, "Pivot R2", color.new(color.blue, 70), 1, plot.style_stepline)
plot(pivotPoint, "Pivot", color.purple, 1, plot.style_stepline)
plot(pivotS1, "Pivot S1", color.new(color.red, 70), 1, plot.style_stepline)

// Position levels
plot(inPosition ? stopLossPrice : na, "Stop Loss", color.red, 1, plot.style_linebr)
plot(inPosition ? entryPrice : na, "Entry", color.yellow, 1, plot.style_linebr)
plot(inPosition ? strikePrice : na, "Strike", color.green, 2, plot.style_circles)

// Entry/Exit markers
plotshape(enterLong, "ENTRY", shape.triangleup, location.belowbar, color.green, size=size.small, text="CC")
plotshape(profitTarget, "PT", shape.flag, location.abovebar, color.lime, size=size.small, text="PT")
plotshape(strikeHit and not profitTarget, "STRIKE", shape.xcross, location.abovebar, color.blue, size=size.small, text="STK")
plotshape(hitStopLoss and not profitTarget and not strikeHit, "SL", shape.triangledown, location.abovebar, color.red, size=size.small, text="SL")
plotshape(timeExit and not profitTarget and not strikeHit and not hitStopLoss, "DTE", shape.diamond, location.abovebar, color.orange, size=size.small, text="DTE")

// Background
bgcolor(inPosition ? color.new(color.green, 95) : na)
bgcolor(stochOverbought and not inPosition ? color.new(color.blue, 95) : na, title="Stoch OB Ready")

// Trailing stop activation indicator
bgcolor(trailActivated ? color.new(color.purple, 90) : na, title="Trail Active")

// === INFO TABLE ===
var table t = table.new(position.top_right, 2, 10, bgcolor=color.new(#1e1e1e, 20), frame_color=color.gray)
if barstate.islast
    table.cell(t, 0, 0, "Stoch %K", text_color=color.white)
    table.cell(t, 1, 0, str.tostring(stochK, "#.#"), text_color=stochOverbought ? color.red : color.gray)
    table.cell(t, 0, 1, "Signal", text_color=color.white)
    table.cell(t, 1, 1, stochOverbought ? "OVERBOUGHT" : "WAIT",
               text_color=stochOverbought ? color.lime : color.gray)
    table.cell(t, 0, 2, "Pivot R1", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(pivotR1, "#.##"), text_color=color.blue)
    table.cell(t, 0, 3, "Strike", text_color=color.white)
    table.cell(t, 1, 3, inPosition ? str.tostring(strikePrice, "#.##") : "-", text_color=color.blue)
    table.cell(t, 0, 4, "P&L", text_color=color.white)
    table.cell(t, 1, 4, inPosition ? str.tostring(totalPnL, "#.##") : "-",
               text_color=totalPnL > 0 ? color.green : color.red)
    table.cell(t, 0, 5, "P&L %", text_color=color.white)
    table.cell(t, 1, 5, inPosition ? str.tostring(pnlPct, "#.#") + "%" : "-",
               text_color=pnlPct > 0 ? color.green : color.red)
    table.cell(t, 0, 6, "Stop Loss", text_color=color.white)
    table.cell(t, 1, 6, inPosition ? str.tostring(stopLossPrice, "#.##") : "-", text_color=color.red)
    table.cell(t, 0, 7, "Trail Active", text_color=color.white)
    table.cell(t, 1, 7, trailActivated ? "YES" : "NO", text_color=trailActivated ? color.purple : color.gray)
    table.cell(t, 0, 8, "Days", text_color=color.white)
    table.cell(t, 1, 8, inPosition ? str.tostring(barsHeld) : "-", text_color=color.white)
    table.cell(t, 0, 9, "Strategy", text_color=color.white)
    table.cell(t, 1, 9, "LOW RISK", text_color=color.aqua)

// === ALERTS ===
alertcondition(enterLong,
               "Covered Call Entry - Stoch OB",
               "ENTRY: Stochastic overbought. Buy stock, Sell Call at Pivot R1")

alertcondition(profitTarget,
               "Profit Target Hit",
               "EXIT: Profit target reached - Close position")

alertcondition(trailActivated and not trailActivated[1],
               "Trailing Stop Activated",
               "INFO: Trailing stop now active - locking in gains")

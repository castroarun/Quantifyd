//@version=5
strategy("CC - ATR Strike + VWAP [FIXED v2]",
         overlay=true,
         initial_capital=1000000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.percent,
         commission_value=0.03,
         slippage=0,
         calc_on_every_tick=false)

// ============================================
// STRATEGY: ATR-Based Strike + VWAP Above
// Best Risk-Adjusted: 13.17% Return | 2.50% Max DD
// ============================================

// === INPUTS ===
grp1 = "ATR Strike"
atrLen = input.int(14, "ATR Length", minval=1, group=grp1)
atrMult = input.float(1.5, "ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, group=grp1)

grp2 = "Covered Call"
premiumPct = input.float(2.5, "Premium % (of stock)", minval=0.5, maxval=5.0, group=grp2)

grp3 = "Exit Rules"
profitTargetPct = input.float(50.0, "Profit Target %", minval=10, maxval=90, group=grp3)
maxDays = input.int(30, "Max Holding Days", minval=7, maxval=60, group=grp3)

// === CALCULATIONS ===
atrVal = ta.atr(atrLen)
vwapVal = ta.vwap(hlc3)

aboveVWAP = close > vwapVal
belowVWAP = close < vwapVal

// Dynamic strike based on ATR
dynamicStrike = close + (atrVal * atrMult)
otmPct = ((dynamicStrike - close) / close) * 100

// === ENTRY ===
// Enter when price crosses above VWAP
crossAboveVWAP = ta.crossover(close, vwapVal)
canEnter = aboveVWAP
enterLong = crossAboveVWAP and strategy.position_size == 0

// === POSITION TRACKING ===
var float entryPrice = na
var float strikePrice = na
var float premium = na
var int entryBar = na

if enterLong
    entryPrice := close
    strikePrice := dynamicStrike
    premium := close * premiumPct / 100
    entryBar := bar_index
    strategy.entry("Buy", strategy.long)

// === EXIT CONDITIONS ===
inPosition = strategy.position_size > 0
barsHeld = bar_index - entryBar

// P&L calculation
stockPnL = inPosition ? (close - entryPrice) : 0
callPayoff = inPosition ? (close >= strikePrice ? -(close - strikePrice) : 0) : 0
totalPnL = stockPnL + premium + callPayoff

// Exits
profitTarget = inPosition and totalPnL >= (premium * profitTargetPct / 100)
vwapBreak = inPosition and belowVWAP
timeExit = inPosition and barsHeld >= maxDays
strikeHit = inPosition and close >= strikePrice

exitLong = profitTarget or vwapBreak or timeExit or strikeHit

if exitLong
    strategy.close("Buy", comment=
        profitTarget ? "PT" :
        strikeHit ? "STRIKE" :
        vwapBreak ? "VWAP" : "DTE")

// === VISUALIZATION ===
plot(vwapVal, "VWAP", color.purple, 2)
plot(inPosition ? strikePrice : na, "Strike (ATR)", color.blue, 2, plot.style_circles)
plot(inPosition ? entryPrice : na, "Entry", color.yellow, 1, plot.style_linebr)

// ATR bands
plot(close + atrVal, "Upper ATR", color.new(color.gray, 80), style=plot.style_linebr)
plot(close - atrVal, "Lower ATR", color.new(color.gray, 80), style=plot.style_linebr)

// Markers
plotshape(enterLong, "ENTRY", shape.triangleup, location.belowbar, color.blue, size=size.small, text="BUY")
plotshape(profitTarget, "PT", shape.flag, location.abovebar, color.lime, size=size.small, text="PT")
plotshape(strikeHit and not profitTarget, "STRIKE", shape.xcross, location.abovebar, color.blue, size=size.small, text="STK")
plotshape(vwapBreak and not profitTarget and not strikeHit, "VWAP", shape.triangledown, location.abovebar, color.red, size=size.small, text="VWAP")
plotshape(timeExit and not profitTarget and not strikeHit and not vwapBreak, "DTE", shape.diamond, location.abovebar, color.orange, size=size.small, text="DTE")

// Background
bgcolor(inPosition ? color.new(color.blue, 95) : na)
bgcolor(aboveVWAP and not inPosition ? color.new(color.green, 97) : na)

// === INFO TABLE ===
var table t = table.new(position.top_right, 2, 7, bgcolor=color.new(#1e1e1e, 20))
if barstate.islast
    table.cell(t, 0, 0, "VWAP", text_color=color.white)
    table.cell(t, 1, 0, aboveVWAP ? "ABOVE" : "BELOW", text_color=aboveVWAP ? color.green : color.red)
    table.cell(t, 0, 1, "ATR", text_color=color.white)
    table.cell(t, 1, 1, str.tostring(atrVal, "#.#"), text_color=color.orange)
    table.cell(t, 0, 2, "Strike", text_color=color.white)
    table.cell(t, 1, 2, inPosition ? str.tostring(strikePrice, "#") : str.tostring(dynamicStrike, "#"), text_color=color.blue)
    table.cell(t, 0, 3, "OTM %", text_color=color.white)
    table.cell(t, 1, 3, str.tostring(otmPct, "#.#") + "%", text_color=color.yellow)
    table.cell(t, 0, 4, "P&L", text_color=color.white)
    table.cell(t, 1, 4, inPosition ? str.tostring(totalPnL, "#.##") : "-", text_color=totalPnL > 0 ? color.green : color.red)
    table.cell(t, 0, 5, "Days", text_color=color.white)
    table.cell(t, 1, 5, inPosition ? str.tostring(barsHeld) : "-", text_color=color.white)
    table.cell(t, 0, 6, "Signal", text_color=color.white)
    table.cell(t, 1, 6, crossAboveVWAP ? "ENTRY!" : aboveVWAP ? "READY" : "WAIT",
               text_color=crossAboveVWAP ? color.lime : aboveVWAP ? color.yellow : color.gray)

{% extends 'base.html' %}

{% block title %}Holdings Dashboard - Covered Calls Backtester{% endblock %}

{% block extra_css %}
<style>
    /* Dark Mode (Default) */
    :root {
        --profit-green: #22c55e;
        --loss-red: #ef4444;
        --card-bg: #1e293b;
        --card-hover: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --border-color: #475569;
        --body-bg: #0f172a;
        --input-bg: #1e293b;
    }

    /* Light Mode - Clean Professional Theme */
    [data-theme="light"] {
        --profit-green: #059669;
        --loss-red: #dc2626;
        --card-bg: #ffffff;
        --card-hover: #f8fafc;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --border-color: #d1d5db;
        --body-bg: #f3f4f6;
        --input-bg: #ffffff;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    }

    [data-theme="light"] body,
    [data-theme="light"] .container-fluid,
    [data-theme="light"] .container {
        background: var(--body-bg) !important;
        color: var(--text-primary) !important;
    }

    [data-theme="light"] .portfolio-summary {
        background: #ffffff !important;
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .sort-btn {
        background: #ffffff !important;
        color: #374151 !important;
        border-color: #d1d5db !important;
    }
    [data-theme="light"] .sort-btn:hover,
    [data-theme="light"] .sort-btn.active {
        background: #2563eb !important;
        color: #ffffff !important;
        border-color: #2563eb !important;
    }

    [data-theme="light"] .view-toggle button,
    [data-theme="light"] .mode-toggle button {
        background: #ffffff !important;
        color: #374151 !important;
    }
    [data-theme="light"] .view-toggle button.active,
    [data-theme="light"] .mode-toggle button.active {
        background: #2563eb !important;
        color: #ffffff !important;
    }

    [data-theme="light"] .flip-card-front,
    [data-theme="light"] .flip-card-back {
        background: #ffffff !important;
        color: #111827 !important;
        box-shadow: var(--shadow-md);
        border-color: #e5e7eb !important;
    }

    [data-theme="light"] .flip-card-back {
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%) !important;
    }

    [data-theme="light"] .flip-card:hover .flip-card-front,
    [data-theme="light"] .flip-card:hover .flip-card-back {
        border-color: #3b82f6 !important;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15) !important;
    }

    [data-theme="light"] .list-row {
        background: #ffffff !important;
        color: #111827 !important;
        border-color: #e5e7eb !important;
    }
    [data-theme="light"] .list-row:hover {
        background: #f9fafb !important;
    }

    [data-theme="light"] .sector-group-header {
        background: #f9fafb !important;
        color: #111827 !important;
    }

    [data-theme="light"] .list-view-container,
    [data-theme="light"] .sector-stocks {
        background: #ffffff !important;
        box-shadow: var(--shadow-sm);
    }

    [data-theme="light"] .chat-panel {
        background: #ffffff !important;
        color: #111827 !important;
        box-shadow: var(--shadow-md);
    }

    [data-theme="light"] .chat-input {
        background: #f9fafb !important;
        color: #111827 !important;
        border-color: #d1d5db !important;
    }

    [data-theme="light"] .summary-stat .value {
        color: #111827 !important;
    }
    [data-theme="light"] .summary-stat .label {
        color: #6b7280 !important;
    }

    [data-theme="light"] .text-secondary,
    [data-theme="light"] .list-stock-symbol,
    [data-theme="light"] .list-metric .label {
        color: #6b7280 !important;
    }

    [data-theme="light"] .expanded-overlay .modal-content {
        background: #ffffff !important;
        color: #111827 !important;
    }

    [data-theme="light"] .theme-toggle {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #374151 !important;
    }

    /* Light Mode - Navbar */
    [data-theme="light"] .navbar {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
        border-bottom: 2px solid #1e3a8a !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Light Mode - Metric items (card grids) */
    [data-theme="light"] .metric-item {
        background: #f8fafc !important;
        border: 1px solid #e5e7eb;
    }
    [data-theme="light"] .metric-item .value {
        color: #111827 !important;
    }
    [data-theme="light"] .metric-item .label {
        color: #6b7280 !important;
    }

    /* Light Mode - Fund boxes */
    [data-theme="light"] .fund-box,
    [data-theme="light"] .exp-fund-box {
        background: #f8fafc !important;
        border: 1px solid #e5e7eb !important;
    }
    [data-theme="light"] .fund-box .title,
    [data-theme="light"] .exp-fund-box .title {
        color: #374151 !important;
    }

    /* Light Mode - Ratio chips */
    [data-theme="light"] .ratio-chip,
    [data-theme="light"] .exp-ratio {
        background: #f8fafc !important;
        border: 1px solid #e5e7eb !important;
    }
    [data-theme="light"] .ratio-chip .value,
    [data-theme="light"] .exp-ratio .value {
        color: #111827 !important;
    }
    [data-theme="light"] .ratio-chip.good .value {
        color: #059669 !important;
    }
    [data-theme="light"] .ratio-chip.warning .value {
        color: #d97706 !important;
    }

    /* Light Mode - P&L Badges */
    [data-theme="light"] .pnl-badge.profit,
    [data-theme="light"] .list-pnl-badge.profit {
        background: rgba(5, 150, 105, 0.15) !important;
        color: #059669 !important;
    }
    [data-theme="light"] .pnl-badge.loss,
    [data-theme="light"] .list-pnl-badge.loss {
        background: rgba(220, 38, 38, 0.15) !important;
        color: #dc2626 !important;
    }

    /* Light Mode - Section headers */
    [data-theme="light"] .list-section-header {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(99, 102, 241, 0.08)) !important;
        border-color: rgba(37, 99, 235, 0.25) !important;
        color: #2563eb !important;
    }

    /* Light Mode - Sector headers */
    [data-theme="light"] .sector-header {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9) !important;
        border-bottom: 1px solid #e5e7eb;
    }
    [data-theme="light"] .sector-name {
        color: #111827 !important;
    }

    /* Light Mode - Expanded card */
    [data-theme="light"] .expanded-card {
        background: #ffffff !important;
        border-color: #e5e7eb !important;
    }
    [data-theme="light"] .expanded-header {
        background: #ffffff !important;
        border-bottom-color: #e5e7eb !important;
    }

    /* Light Mode - Action buttons */
    [data-theme="light"] .action-btn,
    [data-theme="light"] .list-action-btn {
        background: #f8fafc !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
    }
    [data-theme="light"] .action-btn:hover,
    [data-theme="light"] .list-action-btn:hover {
        background: #2563eb !important;
        border-color: #2563eb !important;
        color: #ffffff !important;
    }

    /* Light Mode - Nav arrows */
    [data-theme="light"] .nav-arrow {
        background: rgba(255, 255, 255, 0.95) !important;
        border-color: #d1d5db !important;
        color: #374151 !important;
    }
    [data-theme="light"] .nav-arrow:hover {
        background: #2563eb !important;
        border-color: #2563eb !important;
        color: #ffffff !important;
    }

    /* Light Mode - LTP/Avg container */
    [data-theme="light"] .ltp-divider {
        background: #d1d5db !important;
    }
    [data-theme="light"] .avg-value {
        color: #6b7280 !important;
    }

    /* Light Mode - Text colors */
    [data-theme="light"] .text-success {
        color: #059669 !important;
    }
    [data-theme="light"] .text-danger {
        color: #dc2626 !important;
    }

    /* Theme Toggle Button */
    .theme-toggle {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .theme-toggle:hover {
        background: var(--card-hover);
        color: var(--text-primary);
    }

    .page-header { padding: 1.5rem 0 1rem; }

    .portfolio-summary {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .summary-stat { text-align: center; padding: 0.5rem; }
    .summary-stat .value { font-size: 1.25rem; font-weight: 700; }
    .summary-stat .label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }

    /* Live Price Status Indicator */
    .live-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6b7280;
        animation: none;
    }
    .live-dot.live {
        background: #22c55e;
        animation: livePulse 2s infinite;
    }
    .live-dot.market-closed {
        background: #f59e0b;
    }
    .live-dot.error {
        background: #ef4444;
    }
    @keyframes livePulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
        50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
    }

    /* Price flash animations for real-time updates */
    .price-flash-up {
        animation: flashUp 0.3s ease-out;
    }
    .price-flash-down {
        animation: flashDown 0.3s ease-out;
    }
    @keyframes flashUp {
        0% { background-color: rgba(34, 197, 94, 0.3); }
        100% { background-color: transparent; }
    }
    @keyframes flashDown {
        0% { background-color: rgba(239, 68, 68, 0.3); }
        100% { background-color: transparent; }
    }

    .sort-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .sort-btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .sort-btn:hover, .sort-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* Grid Layout - LARGER CARDS */
    .holdings-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
    }
    @media (max-width: 1400px) { .holdings-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 1100px) { .holdings-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .holdings-grid { grid-template-columns: 1fr; } }

    /* Flip Card Container - LARGER */
    .flip-card {
        perspective: 1000px;
        aspect-ratio: 4 / 3;
        min-height: 280px;
        cursor: pointer;
        position: relative;
    }

    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
    }

    .flip-card-back {
        transform: rotateY(180deg);
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    .flip-card:hover .flip-card-front,
    .flip-card:hover .flip-card-back {
        border-color: #60a5fa;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    /* Card Header */
    .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .stock-info { display: flex; align-items: center; gap: 0.5rem; }

    .stock-logo {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--logo-gradient, linear-gradient(135deg, #3b82f6, #8b5cf6));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.7rem;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stock-logo:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px var(--logo-shadow, rgba(59, 130, 246, 0.4));
    }

    .stock-name { font-weight: 600; font-size: 1rem; line-height: 1.3; }
    .stock-symbol { font-size: 0.75rem; color: var(--text-secondary); }

    .pnl-wrapper {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .pnl-wrapper .pnl-label {
        font-size: 0.55rem;
        color: var(--text-secondary);
        font-weight: 400;
        text-transform: uppercase;
    }
    .pnl-badge {
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 1rem;
    }
    .pnl-badge.profit { background: rgba(34, 197, 94, 0.2); color: var(--profit-green); }
    .pnl-badge.loss { background: rgba(239, 68, 68, 0.2); color: var(--loss-red); }

    /* Metrics Row */
    .metrics-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .metric-item {
        text-align: center;
        padding: 0.5rem 0.6rem;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        flex: 1;
    }
    .metric-item .value { font-size: 1rem; font-weight: 600; white-space: nowrap; }
    .metric-item .label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; }

    /* Chart Container - LARGER */
    .chart-container {
        flex: 1;
        min-height: 70px;
        position: relative;
    }

    /* Extra Info */
    .extra-info-row {
        display: flex;
        justify-content: space-between;
        padding-top: 0.4rem;
        border-top: 1px solid var(--border-color);
        margin-top: auto;
    }
    .info-badge { display: flex; align-items: center; gap: 0.2rem; font-size: 0.6rem; color: var(--text-secondary); }
    .info-badge.dividend { color: #fbbf24; }
    .info-badge.result { color: #a78bfa; }

    /* Flip hint */
    .flip-hint {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        font-size: 0.6rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.25rem;
        opacity: 0.7;
    }

    /* Back of card */
    .back-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .back-title { font-weight: 600; font-size: 0.9rem; }
    .back-close { font-size: 0.7rem; color: var(--text-secondary); }

    .fundamentals-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        flex: 1;
    }
    .fund-box {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 6px;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
    }
    .fund-box .title { font-size: 0.55rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.25rem; }
    .fund-box canvas { height: 45px !important; }

    .ratios-row { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: auto; }
    .ratio-chip {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        border: 1px solid var(--border-color);
        text-align: center;
        flex: 1;
        min-width: 45px;
    }
    .ratio-chip .value { font-size: 0.7rem; font-weight: 600; }
    .ratio-chip .label { font-size: 0.5rem; color: var(--text-secondary); }
    .ratio-chip.good .value { color: var(--profit-green); }
    .ratio-chip.warning .value { color: #fbbf24; }

    /* Expanded View Modal */
    .expanded-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    .expanded-overlay.active { display: flex; }

    .expanded-card {
        background: var(--card-bg);
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 92vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        animation: expandIn 0.3s ease;
    }

    @keyframes expandIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .expanded-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        background: var(--card-bg);
    }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-right { display: flex; align-items: center; gap: 1.5rem; }
    .div-indicator {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    .div-indicator .div-val {
        font-size: 0.95rem;
        font-weight: 600;
        color: #fbbf24;
    }
    .div-indicator .div-lbl {
        font-size: 0.55rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .expanded-body { padding: 1.25rem; }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .close-btn:hover { color: var(--text-primary); }

    /* Navigation arrows */
    .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(30, 41, 59, 0.9);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
    }
    .nav-arrow:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        transform: translateY(-50%) scale(1.1);
    }
    .nav-arrow.prev { left: -70px; }
    .nav-arrow.next { right: -70px; }
    @media (max-width: 1100px) {
        .nav-arrow.prev { left: 10px; }
        .nav-arrow.next { right: 10px; }
        .nav-arrow { background: rgba(30, 41, 59, 0.95); }
    }

    /* Action buttons in header */
    .header-actions {
        display: flex;
        gap: 0.5rem;
        margin-right: 1rem;
    }
    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .action-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    .action-btn.share:hover { background: #25d366; border-color: #25d366; }
    .action-btn.fullscreen:hover { background: #8b5cf6; border-color: #8b5cf6; }

    /* Share modal */
    .share-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    .share-modal.active { display: flex; }
    .share-content {
        background: var(--card-bg);
        border-radius: 16px;
        max-width: 500px;
        width: 100%;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }
    .share-preview {
        background: #0d1117;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        max-height: 300px;
        overflow: hidden;
    }
    .share-preview img {
        width: 100%;
        border-radius: 6px;
    }
    .share-textarea {
        width: 100%;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        color: var(--text-primary);
        resize: none;
        margin-bottom: 1rem;
    }
    .share-textarea:focus {
        outline: none;
        border-color: #3b82f6;
    }
    .share-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }
    .share-btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }
    .share-btn.cancel {
        background: rgba(30, 41, 59, 0.8);
        color: var(--text-secondary);
    }
    .share-btn.whatsapp {
        background: #25d366;
        color: white;
    }
    .share-btn:hover { transform: scale(1.02); }

    /* Stock counter */
    .stock-counter {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-left: 0.5rem;
        font-weight: 600;
    }

    /* Portfolio bar in expanded view */
    .exp-portfolio-bar-container {
        margin-bottom: 1.5rem;
    }
    .exp-portfolio-bar {
        height: 8px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }
    .exp-portfolio-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: var(--invest-pct, 0%);
        background: linear-gradient(90deg, #22c55e, #4ade80);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .exp-portfolio-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.4rem;
    }
    .exp-portfolio-label .value {
        color: #22c55e;
        font-weight: 600;
    }

    .expanded-metrics {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .exp-metric { text-align: center; }
    .exp-metric .value { font-size: 1.5rem; font-weight: 700; }
    .exp-metric .label { font-size: 0.8rem; color: var(--text-secondary); }

    .expanded-chart { height: 220px; margin-bottom: 1.5rem; }

    .expanded-fundamentals {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .exp-fund-box {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.5));
        border-radius: 10px;
        padding: 0.75rem;
        border: none;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 2px 8px rgba(0,0,0,0.2);
    }
    .exp-fund-box .title {
        font-size: 0.65rem;
        color: var(--text-secondary);
        margin-bottom: 0.4rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .exp-fund-box .title::before {
        content: '';
        width: 3px;
        height: 10px;
        border-radius: 2px;
    }
    .exp-fund-box.revenue .title::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); }
    .exp-fund-box.profit .title::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
    .exp-fund-box.opm .title::before { background: linear-gradient(180deg, #f59e0b, #fbbf24); }
    .exp-fund-box canvas { height: 120px !important; }

    .expanded-ratios {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .exp-ratio {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        text-align: center;
        flex: 1;
        min-width: 80px;
    }
    .exp-ratio .value { font-size: 1.1rem; font-weight: 700; }
    .exp-ratio .value .industry-pe { font-weight: 500; color: #94a3b8; font-size: 0.9rem; }
    .exp-ratio .label { font-size: 0.65rem; color: var(--text-secondary); }

    /* View toggle */
    .view-toggle { display: flex; gap: 0.25rem; background: var(--card-bg); border-radius: 6px; padding: 0.2rem; }
    .view-toggle button { background: none; border: none; color: var(--text-secondary); padding: 0.4rem; border-radius: 4px; cursor: pointer; }
    .view-toggle button.active { background: #3b82f6; color: white; }

    /* Mode toggle (Holdings vs Trading) */
    .mode-toggle {
        display: flex;
        gap: 0.25rem;
        background: var(--card-bg);
        border-radius: 6px;
        padding: 0.2rem;
        margin-right: 0.5rem;
    }
    .mode-toggle button {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s;
    }
    .mode-toggle button.active { background: #22c55e; color: white; }
    .mode-toggle button.active.trading { background: #f59e0b; }
    .mode-toggle .loading-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #fbbf24;
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
    }

    /* List View Styles - Enhanced */
    .holdings-list {
        display: none;
        flex-direction: column;
        gap: 0;
    }
    .holdings-list.active { display: flex; }

    .list-section {
        margin-bottom: 1.5rem;
    }
    .list-section-header {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
        border-radius: 8px 8px 0 0;
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-bottom: none;
        font-size: 0.75rem;
        font-weight: 600;
        color: #60a5fa;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .list-items {
        border: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
        overflow: hidden;
    }

    .list-row {
        display: grid;
        grid-template-columns: 180px 1fr 36px;
        align-items: center;
        padding: 0.6rem 1rem;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s;
        gap: 0.75rem;
        min-height: 80px;
        max-height: 90px;
        overflow: hidden;
    }
    .list-row:last-child { border-bottom: none; }
    .list-row:hover { background: var(--card-hover); }

    .list-stock-info {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }
    .list-stock-logo {
        width: 38px;
        height: 38px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.6rem;
        flex-shrink: 0;
    }
    .list-stock-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 110px; }
    .list-stock-symbol { font-size: 0.65rem; color: var(--text-secondary); }
    .list-stock-sector { font-size: 0.55rem; color: #8b5cf6; background: rgba(139, 92, 246, 0.15); padding: 0.1rem 0.3rem; border-radius: 3px; display: inline-block; margin-top: 2px; }

    .list-metrics {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.5rem;
        overflow: hidden;
    }
    .list-metric {
        text-align: center;
        padding: 0.15rem 0.2rem;
        flex: 1 1 auto;
        min-width: 65px;
        max-width: 120px;
        max-height: 60px;
        overflow: hidden;
    }
    .list-metric .value {
        font-size: 0.95rem;
        font-weight: 700;
    }
    .list-metric .value.large {
        font-size: 1.1rem;
    }
    .pnl-pct-inline {
        font-size: 0.85rem;
        font-weight: 600;
        opacity: 0.9;
    }
    .list-metric .label {
        font-size: 0.55rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .list-metric .sub-value {
        font-size: 0.6rem;
        color: var(--text-secondary);
    }

    .list-pnl-badge {
        padding: 0.4rem 0.5rem;
        border-radius: 6px;
        font-weight: 800;
        font-size: 1rem;
        text-align: center;
    }
    .list-pnl-badge.profit { background: rgba(34, 197, 94, 0.2); color: var(--profit-green); }
    .list-pnl-badge.loss { background: rgba(239, 68, 68, 0.2); color: var(--loss-red); }

    .list-pnl-amount {
        font-size: 0.95rem;
        font-weight: 700;
        text-align: center;
    }

    .list-sparkline {
        width: 80px;
        height: 32px;
        flex-shrink: 0;
    }

    .list-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .list-action-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* LTP/Avg Price Format */
    .ltp-avg-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }
    .ltp-value {
        font-size: 1rem;
        font-weight: 700;
    }
    .ltp-divider {
        width: 30px;
        height: 1px;
        background: var(--border-color);
    }
    .avg-value {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* Mini Ticker Charts */
    .mini-ticker {
        width: 70px !important;
        height: 40px !important;
        max-width: 70px;
        max-height: 40px;
    }
    .mini-ticker-label {
        font-size: 0.5rem;
        color: var(--text-secondary);
        text-align: center;
        margin-top: 2px;
    }
    .ticker-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 70px;
        height: 52px;
        overflow: hidden;
        flex-shrink: 0;
    }

    /* Trading Mode Card Styles */
    .trading-mode .pnl-label { display: none; }
    .trading-mode .metric-item.trading-metric { display: block; }
    .trading-mode .metric-item.default-metric { display: none; }
    .metric-item.trading-metric { display: none; }

    /* CPR/EMA Indicators */
    .cpr-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    .cpr-badge.above { background: rgba(34, 197, 94, 0.2); color: var(--profit-green); }
    .cpr-badge.below { background: rgba(239, 68, 68, 0.2); color: var(--loss-red); }

    .ema-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    .ema-badge.bullish { background: rgba(34, 197, 94, 0.2); color: var(--profit-green); }
    .ema-badge.bearish { background: rgba(239, 68, 68, 0.2); color: var(--loss-red); }
    .ema-badge.neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }

    /* Responsive list view */
    @media (max-width: 768px) {
        .list-row { grid-template-columns: 140px 1fr 32px; }
        .list-stock-info { min-width: 140px; }
        .list-metrics { flex-wrap: wrap; }
        .list-metric { min-width: 60px; }
        .ticker-container { display: none; }
    }

    /* Sector View - Collapsible */
    .sector-group {
        margin-bottom: 1rem;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .sector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(30, 41, 59, 0.8));
        cursor: pointer;
        transition: all 0.2s;
    }
    .sector-header:hover { background: rgba(59, 130, 246, 0.1); }
    .sector-header.collapsed .sector-toggle { transform: rotate(-90deg); }
    .sector-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .sector-toggle {
        transition: transform 0.2s;
        color: #60a5fa;
    }
    .sector-count {
        font-size: 0.7rem;
        color: var(--text-secondary);
        font-weight: 400;
        background: rgba(59, 130, 246, 0.2);
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        margin-left: 0.5rem;
    }
    .sector-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }
    .sector-stat {
        text-align: right;
    }
    .sector-stat .value {
        font-size: 0.9rem;
        font-weight: 600;
    }
    .sector-stat .label {
        font-size: 0.6rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    .sector-content {
        max-height: 2000px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .sector-content.collapsed {
        max-height: 0;
    }
    .sector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        padding: 1rem;
        background: rgba(15, 23, 42, 0.5);
    }

    /* Portfolio Chart Modal */
    .portfolio-chart-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    .portfolio-chart-modal.active { display: flex; }
    .portfolio-chart-container {
        width: 100%;
        max-width: 1400px;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        position: relative;
    }
    .portfolio-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .portfolio-chart-title {
        font-size: 1.2rem;
        font-weight: 600;
    }
    .portfolio-chart-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(239, 68, 68, 0.2);
        border: none;
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    .portfolio-chart-wrapper {
        height: 500px;
        position: relative;
    }
    .portfolio-chart-legend {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 1rem;
        font-size: 0.8rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .legend-dot.portfolio { background: #3b82f6; }
    .legend-dot.nifty { background: #f59e0b; }

    /* Investment Size Bar */
    .invest-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        width: var(--invest-pct, 50%);
        background: linear-gradient(90deg, #22c55e, #4ade80);
        border-radius: 0 0 0 12px;
        z-index: 5;
        opacity: 0.9;
    }
    .flip-card-front .invest-bar,
    .flip-card-back .invest-bar {
        position: absolute;
        bottom: 0;
        left: 0;
    }

    /* Sector View Styles */
    .sector-group {
        margin-bottom: 1.5rem;
    }
    .sector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
        border-radius: 10px;
        margin-bottom: 0.75rem;
        border: 1px solid rgba(59, 130, 246, 0.3);
        cursor: pointer;
    }
    .sector-header:hover { background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.15)); }
    .sector-name {
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .sector-name i { color: #3b82f6; }
    .sector-count {
        background: rgba(59, 130, 246, 0.2);
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        color: #60a5fa;
    }
    .sector-stats {
        display: flex;
        gap: 1.5rem;
    }
    .sector-stat {
        text-align: right;
    }
    .sector-stat .value { font-size: 0.85rem; font-weight: 600; }
    .sector-stat .label { font-size: 0.6rem; color: var(--text-secondary); }
    .sector-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }
    @media (max-width: 1200px) { .sector-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 992px) { .sector-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 576px) { .sector-grid { grid-template-columns: 1fr; } }
    .sector-content { display: block; }
    .sector-content.collapsed { display: none; }
    .sector-toggle { transition: transform 0.3s; }
    .sector-header.collapsed .sector-toggle { transform: rotate(-90deg); }

    /* Loading state */
    .loading-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        color: var(--text-secondary);
    }
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 1rem;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ========================================
       AI Chat Interface
       NOTE: Chat is hidden by default. To enable:
       1. Set ANTHROPIC_API_KEY environment variable
       2. Remove "display: none" from .chat-fab and .chat-panel
       Or use Claude Code with MCP server (no API cost) - see docs
    ======================================== */
    .chat-fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        display: flex; /* Enabled for API-based chat */
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        z-index: 1000;
    }
    .chat-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 24px rgba(139, 92, 246, 0.5);
    }
    .chat-fab.active {
        transform: rotate(45deg);
    }

    .chat-panel {
        position: fixed;
        bottom: 6rem;
        right: 2rem;
        width: 400px;
        max-width: calc(100vw - 2rem);
        height: 500px;
        max-height: calc(100vh - 8rem);
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px) scale(0.95);
        transition: all 0.3s ease;
    }
    .chat-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-header h5 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }
    .chat-header h5 i {
        color: #8b5cf6;
    }
    .chat-clear-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chat-clear-btn:hover {
        background: var(--card-hover);
        color: var(--text-primary);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .chat-message {
        max-width: 90%;
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        line-height: 1.5;
    }
    .chat-message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }
    .chat-message.assistant {
        align-self: flex-start;
        background: var(--card-hover);
        color: var(--text-primary);
    }
    .chat-message.assistant pre {
        background: rgba(0,0,0,0.2);
        padding: 0.5rem;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.75rem;
        margin: 0.5rem 0;
    }
    .chat-message.assistant code {
        font-size: 0.75rem;
        background: rgba(0,0,0,0.2);
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
    }
    .chat-message.error {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }

    .chat-suggestions {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .suggestion-chip {
        background: var(--card-hover);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.35rem 0.65rem;
        border-radius: 20px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .suggestion-chip:hover {
        background: #8b5cf6;
        border-color: #8b5cf6;
        color: white;
    }

    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 0.5rem;
    }
    .chat-input {
        flex: 1;
        background: var(--card-hover);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.6rem 0.75rem;
        color: var(--text-primary);
        font-size: 0.85rem;
        outline: none;
        resize: none;
        min-height: 40px;
        max-height: 100px;
    }
    .chat-input:focus {
        border-color: #8b5cf6;
    }
    .chat-input::placeholder {
        color: var(--text-secondary);
    }
    .chat-send-btn {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .chat-send-btn:hover {
        transform: scale(1.05);
    }
    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .chat-typing {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem;
    }
    .chat-typing span {
        width: 8px;
        height: 8px;
        background: #8b5cf6;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    .chat-typing span:nth-child(1) { animation-delay: -0.32s; }
    .chat-typing span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    @media (max-width: 500px) {
        .chat-panel {
            width: calc(100vw - 2rem);
            right: 1rem;
            bottom: 5rem;
        }
        .chat-fab {
            right: 1rem;
            bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">My Holdings</h5>
                <p class="text-secondary mb-0 small" id="stockCount">Loading...</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- Mode toggle: Holdings vs Trading -->
                <div class="mode-toggle">
                    <button class="active" data-mode="holdings" onclick="switchMode('holdings')" title="Holdings View">
                        <i class="bi bi-wallet2"></i> Holdings
                    </button>
                    <button data-mode="trading" onclick="switchMode('trading')" title="Trading View (Today's Data)">
                        <i class="bi bi-graph-up-arrow"></i> Trading
                        <span class="loading-dot" id="tradingLoadingDot" style="display: none;"></span>
                    </button>
                </div>
                <!-- View toggle: Grid, List, Sector -->
                <div class="view-toggle">
                    <button class="active" data-view="grid" title="Grid View" onclick="switchView('grid')"><i class="bi bi-grid-3x3-gap"></i></button>
                    <button data-view="list" title="List View" onclick="switchView('list')"><i class="bi bi-list-ul"></i></button>
                    <button data-view="sector" title="Sector View" onclick="switchView('sector')"><i class="bi bi-collection"></i></button>
                </div>
                <!-- Theme toggle -->
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Portfolio Summary -->
    <div class="portfolio-summary">
        <div class="row align-items-center">
            <div class="col"><div class="summary-stat"><div class="value" id="totalInvested">-</div><div class="label">Invested</div></div></div>
            <div class="col"><div class="summary-stat"><div class="value" id="totalCurrent">-</div><div class="label">Current</div></div></div>
            <div class="col"><div class="summary-stat"><div class="value" id="totalPnl">-</div><div class="label">P&L</div></div></div>
            <div class="col"><div class="summary-stat"><div class="value" id="totalReturns">-</div><div class="label">Returns</div></div></div>
            <div class="col-auto px-2"><div style="width: 1px; height: 40px; background: var(--border-color);"></div></div>
            <div class="col"><div class="summary-stat"><div class="value text-success" id="count100Plus">0</div><div class="label">100%+</div></div></div>
            <div class="col"><div class="summary-stat"><div class="value text-success" id="count200Plus">0</div><div class="label">200%+</div></div></div>
            <div class="col"><div class="summary-stat"><div class="value text-success" id="count300Plus">0</div><div class="label">300%+</div></div></div>
            <div class="col-auto px-2"><div style="width: 1px; height: 40px; background: var(--border-color);"></div></div>
            <div class="col-auto">
                <div class="summary-stat" style="min-width: 100px;">
                    <div class="d-flex align-items-center gap-2">
                        <span class="live-dot" id="liveDot" title="Live prices"></span>
                        <span class="value" id="liveStatus" style="font-size: 0.85rem;">--</span>
                    </div>
                    <div class="label" id="lastUpdated">Connecting...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sort Controls -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <div class="sort-controls">
            <button class="sort-btn active" data-sort="pnl_pct">P/L %</button>
            <button class="sort-btn" data-sort="invested">Invested</button>
            <button class="sort-btn" data-sort="current">Current</button>
            <button class="sort-btn" data-sort="pnl">P/L</button>
            <button class="sort-btn" data-sort="alpha">A-Z</button>
            <button class="sort-btn" data-sort="div_yield">Div Yield</button>
        </div>
        <div class="d-flex gap-2">
            <button class="sort-btn" id="sortOrder" onclick="toggleSortOrder()"><i class="bi bi-sort-down"></i></button>
            <button class="sort-btn" onclick="showPortfolioChart()" title="Portfolio vs Nifty 50"><i class="bi bi-bar-chart-line"></i></button>
        </div>
    </div>

    <!-- Holdings Grid -->
    <div class="holdings-grid" id="holdingsGrid">
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <span>Loading holdings...</span>
        </div>
    </div>

    <!-- List View Container (hidden by default) -->
    <div class="holdings-list" id="listView"></div>

    <!-- Sector View Container (hidden by default) -->
    <div id="sector-view" style="display: none;"></div>
</div>

<!-- Portfolio Chart Modal -->
<div class="portfolio-chart-modal" id="portfolioChartModal" onclick="closePortfolioChart(event)">
    <div class="portfolio-chart-container" onclick="event.stopPropagation()">
        <div class="portfolio-chart-header">
            <div class="portfolio-chart-title"><i class="bi bi-bar-chart-line me-2"></i>Portfolio Performance vs Nifty 50</div>
            <button class="portfolio-chart-close" onclick="closePortfolioChart()"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="portfolio-chart-wrapper">
            <canvas id="portfolioCompareChart"></canvas>
        </div>
        <div class="portfolio-chart-legend">
            <div class="legend-item"><span class="legend-dot portfolio"></span> Portfolio</div>
            <div class="legend-item"><span class="legend-dot nifty"></span> Nifty 50</div>
        </div>
    </div>
</div>

<!-- Expanded View Overlay -->
<div class="expanded-overlay" id="expandedOverlay" onclick="closeExpanded(event)">
    <!-- Navigation Arrows -->
    <button class="nav-arrow prev" onclick="navigateStock(-1)" title="Previous ()"><i class="bi bi-chevron-left"></i></button>
    <button class="nav-arrow next" onclick="navigateStock(1)" title="Next ()"><i class="bi bi-chevron-right"></i></button>

    <div class="expanded-card" id="expandedCard" onclick="event.stopPropagation()">
        <div class="expanded-header">
            <div class="header-left">
                <div class="stock-logo" id="exp-logo">RIL</div>
                <div>
                    <div class="stock-name" id="exp-name">Loading...<span class="stock-counter" id="exp-counter"></span></div>
                    <div class="stock-symbol" id="exp-symbol">-</div>
                </div>
            </div>
            <div class="header-right">
                <div class="div-indicator">
                    <span class="div-val" id="exp-div-yield">-</span>
                    <span class="div-lbl">D.Yield</span>
                </div>
                <div class="div-indicator">
                    <span class="div-val" id="exp-div-date">-</span>
                    <span class="div-lbl">Next Div</span>
                </div>
                <div class="header-actions">
                    <button class="action-btn share" onclick="openShareModal()" title="Share on WhatsApp"><i class="bi bi-whatsapp"></i></button>
                    <button class="action-btn fullscreen" onclick="openFullScreen()" title="Full Screen Details"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
                <button class="close-btn" onclick="closeExpanded(event)">&times;</button>
            </div>
        </div>
        <div class="expanded-body">
            <div class="expanded-metrics">
                <div class="exp-metric"><div class="value" id="exp-invested">-</div><div class="label">Invested</div></div>
                <div class="exp-metric"><div class="value" id="exp-current">-</div><div class="label">Current</div></div>
                <div class="exp-metric"><div class="value" id="exp-pnl">-</div><div class="label">P&L</div></div>
                <div class="exp-metric"><div class="value" id="exp-pnl-pct">-</div><div class="label">Returns</div></div>
            </div>

            <!-- Portfolio Weight Bar -->
            <div class="exp-portfolio-bar-container">
                <div class="exp-portfolio-bar" id="exp-portfolio-bar" style="--invest-pct: 0%;"></div>
                <div class="exp-portfolio-label">
                    <span>Portfolio Weight</span>
                    <span class="value" id="exp-portfolio-pct">0% of portfolio</span>
                </div>
            </div>

            <p class="text-secondary small mb-3" id="exp-overview">Loading...</p>

            <div class="expanded-fundamentals">
                <div class="exp-fund-box revenue"><div class="title">Revenue (Cr)</div><canvas id="exp-revenue"></canvas></div>
                <div class="exp-fund-box profit"><div class="title">Net Profit (Cr)</div><canvas id="exp-profit"></canvas></div>
                <div class="exp-fund-box opm"><div class="title">OPM %</div><canvas id="exp-opm"></canvas></div>
            </div>
            <div class="expanded-ratios" id="exp-ratios">
                <!-- Ratios populated by JS -->
            </div>

            <!-- Price Chart at bottom -->
            <div class="expanded-chart mt-3"><canvas id="exp-chart"></canvas></div>
        </div>
    </div>
</div>
<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-content" onclick="event.stopPropagation()">
        <h5 class="mb-3"><i class="bi bi-share me-2"></i>Share on WhatsApp</h5>
        <div class="share-preview" id="sharePreview">
            <p class="text-secondary text-center py-4">Generating preview...</p>
        </div>
        <textarea class="share-textarea" id="shareCommentary" rows="3" placeholder="Add your commentary (optional)..."></textarea>
        <div class="share-actions">
            <button class="share-btn cancel" onclick="closeShareModal(event)">Cancel</button>
            <button class="share-btn whatsapp" onclick="shareToWhatsApp()"><i class="bi bi-whatsapp me-2"></i>Share</button>
        </div>
    </div>
</div>

<!-- AI Chat Floating Button -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()" title="Ask Claude about your portfolio">
    <i class="bi bi-chat-dots"></i>
</button>

<!-- AI Chat Panel -->
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <h5><i class="bi bi-robot"></i> Portfolio Research</h5>
        <button class="chat-clear-btn" onclick="clearChatHistory()">Clear Chat</button>
    </div>
    <div class="chat-suggestions" id="chatSuggestions">
        <!-- Suggestions populated by JS -->
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="chat-message assistant">
            Hi! I'm your portfolio research assistant. Ask me about your holdings, fundamentals, or trading signals.
        </div>
    </div>
    <div class="chat-input-area">
        <textarea class="chat-input" id="chatInput" placeholder="Ask about your portfolio..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
            <i class="bi bi-send"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html2canvas for screenshots -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Socket.IO client for live ticker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

<script>
    // Theme toggle function
    function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById('themeIcon');
        const currentTheme = html.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('holdingsTheme', newTheme);

        // Update icon
        icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
    }

    // Initialize theme from localStorage
    function initTheme() {
        const savedTheme = localStorage.getItem('holdingsTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const icon = document.getElementById('themeIcon');
        if (icon) {
            icon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }
    }

    // Initialize theme immediately
    initTheme();

    // Global state
    let holdingsData = [];
    let currentExpandedIndex = -1;  // Track current stock index in expanded view
    let currentSort = 'pnl_pct';
    let sortAscending = false;
    let currentMode = 'holdings';  // 'holdings' or 'trading'
    let currentView = 'grid';  // 'grid', 'list', or 'sector'
    let tradingDataLoaded = false;
    let tradingData = {};  // Store trading data (CPR, EMA, today's %) per symbol

    // Store chart instances for cleanup
    let expChartInstance = null;
    let expRevenueInstance = null;
    let expProfitInstance = null;
    let expOpmInstance = null;
    let sparklineCharts = {};
    let listDayCharts = {};  // Track day ticker charts in list view
    let list1YCharts = {};   // Track 1Y ticker charts in list view

    // Socket.IO for live ticker
    let socket = null;
    let socketConnected = false;
    let useSocketIO = true;  // Try socket first, fallback to polling

    // Cache configuration - increment version to force refresh
    const CACHE_VERSION = 'v3';  // Increment when data structure changes (v3: dynamic labels, unique colors)
    const CACHE_KEY_PREFIX = `cc_holdings_${CACHE_VERSION}_`;
    const CACHE_EXPIRY_MS = 24 * 60 * 60 * 1000; // 24 hours

    // Clear old version caches on load
    (function clearOldVersionCaches() {
        const allKeys = Object.keys(localStorage);
        allKeys.forEach(k => {
            if (k.startsWith('cc_holdings_') && !k.startsWith(CACHE_KEY_PREFIX)) {
                localStorage.removeItem(k);
            }
        });
    })();

    // LocalStorage cache helpers
    function getCachedData(key) {
        try {
            const cached = localStorage.getItem(CACHE_KEY_PREFIX + key);
            if (!cached) return null;

            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp > CACHE_EXPIRY_MS) {
                localStorage.removeItem(CACHE_KEY_PREFIX + key);
                return null;
            }
            return data;
        } catch (e) {
            return null;
        }
    }

    function setCachedData(key, data) {
        try {
            localStorage.setItem(CACHE_KEY_PREFIX + key, JSON.stringify({
                data: data,
                timestamp: Date.now()
            }));
        } catch (e) {
            // Storage full, clear old cache
            clearOldCache();
        }
    }

    function clearOldCache() {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(CACHE_KEY_PREFIX));
        keys.forEach(k => localStorage.removeItem(k));
    }

    // Stock color palette - consistent colors per stock
    const STOCK_COLORS = [
        { gradient: 'linear-gradient(135deg, #3b82f6, #60a5fa)', shadow: 'rgba(59, 130, 246, 0.4)' },   // Blue
        { gradient: 'linear-gradient(135deg, #8b5cf6, #a78bfa)', shadow: 'rgba(139, 92, 246, 0.4)' },   // Purple
        { gradient: 'linear-gradient(135deg, #ec4899, #f472b6)', shadow: 'rgba(236, 72, 153, 0.4)' },   // Pink
        { gradient: 'linear-gradient(135deg, #22c55e, #4ade80)', shadow: 'rgba(34, 197, 94, 0.4)' },    // Green
        { gradient: 'linear-gradient(135deg, #f59e0b, #fbbf24)', shadow: 'rgba(245, 158, 11, 0.4)' },   // Amber
        { gradient: 'linear-gradient(135deg, #ef4444, #f87171)', shadow: 'rgba(239, 68, 68, 0.4)' },    // Red
        { gradient: 'linear-gradient(135deg, #14b8a6, #2dd4bf)', shadow: 'rgba(20, 184, 166, 0.4)' },   // Teal
        { gradient: 'linear-gradient(135deg, #6366f1, #818cf8)', shadow: 'rgba(99, 102, 241, 0.4)' },   // Indigo
        { gradient: 'linear-gradient(135deg, #f97316, #fb923c)', shadow: 'rgba(249, 115, 22, 0.4)' },   // Orange
        { gradient: 'linear-gradient(135deg, #84cc16, #a3e635)', shadow: 'rgba(132, 204, 22, 0.4)' },   // Lime
        { gradient: 'linear-gradient(135deg, #0ea5e9, #38bdf8)', shadow: 'rgba(14, 165, 233, 0.4)' },   // Sky
        { gradient: 'linear-gradient(135deg, #d946ef, #e879f9)', shadow: 'rgba(217, 70, 239, 0.4)' },   // Fuchsia
    ];

    // Get consistent color for a stock symbol (hash-based)
    function getStockColor(symbol) {
        let hash = 0;
        for (let i = 0; i < symbol.length; i++) {
            hash = ((hash << 5) - hash) + symbol.charCodeAt(i);
            hash = hash & hash; // Convert to 32bit integer
        }
        const index = Math.abs(hash) % STOCK_COLORS.length;
        return STOCK_COLORS[index];
    }

    // Format currency in Indian style
    function formatCurrency(amount, prefix = '') {
        const absAmount = Math.abs(amount);
        if (absAmount >= 1e7) {
            return `${prefix}${(amount/1e7).toFixed(2)}Cr`;
        } else if (absAmount >= 1e5) {
            return `${prefix}${(amount/1e5).toFixed(2)}L`;
        } else if (absAmount >= 1e3) {
            return `${prefix}${(amount/1e3).toFixed(1)}K`;
        }
        return `${prefix}${amount.toFixed(0)}`;
    }

    // Load holdings from API
    async function loadHoldings() {
        try {
            const response = await fetch('/api/holdings');
            if (!response.ok) throw new Error('Failed to fetch holdings');

            const data = await response.json();
            holdingsData = data.holdings || [];

            // Update summary
            updateSummary(data.summary);

            // Render cards
            renderHoldingCards();

            // Pre-fetch remaining data in background after short delay
            setTimeout(prefetchAllData, 2000);

        } catch (error) {
            console.error('Error loading holdings:', error);
            document.getElementById('holdingsGrid').innerHTML = `
                <div class="loading-overlay">
                    <i class="bi bi-exclamation-circle text-danger me-2" style="font-size: 2rem;"></i>
                    <span>Error loading holdings. Please try again.</span>
                </div>
            `;
        }
    }

    // =========================================================================
    // Live Price Auto-Refresh
    // =========================================================================

    let refreshInterval = null;
    let lastRefreshTime = null;
    const REFRESH_INTERVAL_MS = 5000; // 5 seconds - faster updates during market hours

    // Check if Indian market is open (9:15 AM - 3:30 PM IST)
    function isMarketOpen() {
        const now = new Date();
        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60 * 1000;
        const istTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60 * 1000) + istOffset);

        const day = istTime.getDay();
        const hours = istTime.getHours();
        const minutes = istTime.getMinutes();
        const timeInMinutes = hours * 60 + minutes;

        // Market hours: 9:15 AM (555 min) to 3:30 PM (930 min), Mon-Fri
        const marketOpen = 9 * 60 + 15;  // 9:15 AM
        const marketClose = 15 * 60 + 30; // 3:30 PM

        // Weekend check (0 = Sunday, 6 = Saturday)
        if (day === 0 || day === 6) return false;

        return timeInMinutes >= marketOpen && timeInMinutes <= marketClose;
    }

    // Update live status indicator
    function updateLiveStatus(status, message) {
        const dot = document.getElementById('liveDot');
        const statusEl = document.getElementById('liveStatus');
        const updatedEl = document.getElementById('lastUpdated');

        if (!dot || !statusEl) return;

        dot.classList.remove('live', 'market-closed', 'error');

        if (status === 'live') {
            dot.classList.add('live');
            statusEl.textContent = 'LIVE';
            statusEl.style.color = 'var(--profit-green)';
        } else if (status === 'closed') {
            dot.classList.add('market-closed');
            statusEl.textContent = 'Closed';
            statusEl.style.color = '#f59e0b';
        } else if (status === 'error') {
            dot.classList.add('error');
            statusEl.textContent = 'Error';
            statusEl.style.color = 'var(--loss-red)';
        }

        if (updatedEl && message) {
            updatedEl.textContent = message;
        }
    }

    // Format time for display
    function formatUpdateTime(date) {
        return date.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    // Refresh prices without full re-render
    async function refreshPrices() {
        try {
            const response = await fetch('/api/holdings');
            if (!response.ok) throw new Error('Failed to fetch holdings');

            const data = await response.json();
            const newHoldings = data.holdings || [];

            // Update holdingsData prices
            newHoldings.forEach(newH => {
                const existing = holdingsData.find(h => h.symbol === newH.symbol);
                if (existing) {
                    existing.last_price = newH.last_price;
                    existing.current = newH.current;
                    existing.pnl = newH.pnl;
                    existing.pnl_pct = newH.pnl_pct;
                    existing.is_profit = newH.is_profit;
                    existing.day_change = newH.day_change;
                    existing.day_change_pct = newH.day_change_pct;
                }
            });

            // Update summary stats
            updateSummary(data.summary);

            // Update prices in current view (cards or list)
            updatePricesInView();

            lastRefreshTime = new Date();
            updateLiveStatus('live', `Updated ${formatUpdateTime(lastRefreshTime)}`);

        } catch (error) {
            console.error('Error refreshing prices:', error);
            updateLiveStatus('error', 'Refresh failed');
        }
    }

    // Update prices in the current view without full re-render
    function updatePricesInView() {
        holdingsData.forEach(h => {
            // Update card view prices
            const priceEl = document.querySelector(`[data-symbol="${h.symbol}"] .stock-ltp`);
            if (priceEl) {
                priceEl.textContent = `${parseFloat(h.last_price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }

            // Update P&L badges - show today's % in Trading mode, overall P/L in Holdings mode
            const pnlBadge = document.querySelector(`[data-symbol="${h.symbol}"] .pnl-badge`);
            if (pnlBadge) {
                const isTrading = currentMode === 'trading';
                if (isTrading) {
                    const td = tradingData[h.symbol] || {};
                    const todayPct = td.today_pct || 0;
                    const todaySign = todayPct >= 0 ? '+' : '';
                    const todayClass = todayPct >= 0 ? 'profit' : 'loss';
                    pnlBadge.textContent = `${todaySign}${todayPct.toFixed(2)}%`;
                    pnlBadge.className = `pnl-badge ${todayClass}`;
                } else {
                    const pnlSign = h.is_profit ? '+' : '';
                    pnlBadge.textContent = `${pnlSign}${parseFloat(h.pnl_pct).toFixed(1)}%`;
                    pnlBadge.className = `pnl-badge ${h.is_profit ? 'profit' : 'loss'}`;
                }
            }

            // Update list view prices if visible
            const listPrice = document.querySelector(`.list-row[data-symbol="${h.symbol}"] .list-stock-ltp`);
            if (listPrice) {
                listPrice.textContent = `${parseFloat(h.last_price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }

            const listPnl = document.querySelector(`.list-row[data-symbol="${h.symbol}"] .list-pnl-badge`);
            if (listPnl) {
                const pnlSign = h.is_profit ? '+' : '';
                listPnl.textContent = `${pnlSign}${parseFloat(h.pnl_pct).toFixed(1)}%`;
                listPnl.className = `list-pnl-badge ${h.is_profit ? 'profit' : 'loss'}`;
            }
        });
    }

    // Start/stop auto-refresh based on market hours
    function manageAutoRefresh() {
        if (isMarketOpen()) {
            if (!refreshInterval) {
                console.log('Market open - starting auto-refresh');
                refreshPrices(); // Immediate refresh
                refreshInterval = setInterval(refreshPrices, REFRESH_INTERVAL_MS);
                updateLiveStatus('live', 'Auto-refresh active');
            }
        } else {
            if (refreshInterval) {
                console.log('Market closed - stopping auto-refresh');
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            updateLiveStatus('closed', 'Market closed');
        }
    }

    // Initialize auto-refresh system
    function initAutoRefresh() {
        // Check market status immediately
        manageAutoRefresh();

        // Re-check market status every minute
        setInterval(manageAutoRefresh, 60000);
    }

    // =========================================================================
    // Socket.IO Live Ticker Integration
    // =========================================================================

    // Initialize Socket.IO connection for live price streaming
    function initSocketIO() {
        if (!useSocketIO) {
            console.log('Socket.IO disabled, using polling only');
            return;
        }

        try {
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            socket.on('connect', () => {
                console.log('Socket.IO connected');
                socketConnected = true;

                // Subscribe to all holdings symbols
                const symbols = holdingsData.map(h => h.symbol);
                if (symbols.length > 0) {
                    socket.emit('subscribe_ticker', { symbols: symbols });
                    console.log('Subscribed to ticker for:', symbols);
                }

                updateLiveStatus('live', 'WebSocket connected');
            });

            socket.on('disconnect', (reason) => {
                console.log('Socket.IO disconnected:', reason);
                socketConnected = false;
                updateLiveStatus('error', 'Disconnected - reconnecting...');
            });

            socket.on('connect_error', (error) => {
                console.error('Socket.IO connection error:', error);
                socketConnected = false;
                // Fall back to polling if socket fails
                if (!refreshInterval && isMarketOpen()) {
                    console.log('Socket.IO failed, falling back to polling');
                    manageAutoRefresh();
                }
            });

            // Handle live price ticks
            socket.on('price_tick', (data) => {
                handleSocketPriceTick(data);
            });

            // Handle subscription confirmation
            socket.on('ticker_subscribed', (data) => {
                console.log('Ticker subscription confirmed:', data);
            });

            // Handle ticker errors
            socket.on('ticker_error', (data) => {
                console.error('Ticker error:', data.error);
            });

        } catch (error) {
            console.error('Failed to initialize Socket.IO:', error);
            socketConnected = false;
            useSocketIO = false;
        }
    }

    // Handle incoming price tick from WebSocket
    function handleSocketPriceTick(data) {
        const symbol = data.symbol;
        if (!symbol) return;

        // Find the holding
        const holding = holdingsData.find(h => h.symbol === symbol);
        if (!holding) return;

        // Update holding data
        const prevPrice = holding.last_price || 0;
        holding.last_price = data.ltp;
        holding.current = data.ltp * (holding.quantity || 0);
        holding.pnl = holding.current - holding.invested;
        holding.pnl_pct = holding.invested > 0 ? ((holding.pnl / holding.invested) * 100).toFixed(2) : 0;
        holding.is_profit = holding.pnl >= 0;
        holding.day_change = data.change || 0;
        holding.day_change_pct = data.change_pct || 0;

        // Update trading data if available
        if (tradingData[symbol]) {
            tradingData[symbol].ltp = data.ltp;
            tradingData[symbol].today_pct = data.change_pct || 0;
            tradingData[symbol].day_change = data.change || 0;
            tradingData[symbol].day_high = data.high || tradingData[symbol].day_high;
            tradingData[symbol].day_low = data.low || tradingData[symbol].day_low;
        }

        // Update UI for this symbol
        updateSingleStockUI(symbol, data, prevPrice);

        // Update last refresh time
        lastRefreshTime = new Date();
        updateLiveStatus('live', `Tick ${formatUpdateTime(lastRefreshTime)}`);
    }

    // Update UI for a single stock (optimized for real-time updates)
    function updateSingleStockUI(symbol, data, prevPrice) {
        const holding = holdingsData.find(h => h.symbol === symbol);
        if (!holding) return;

        const isTrading = currentMode === 'trading';
        const priceUp = data.ltp > prevPrice;
        const priceClass = priceUp ? 'price-flash-up' : 'price-flash-down';

        // Update card view LTP
        const cardPriceEl = document.querySelector(`[data-symbol="${symbol}"] .stock-ltp`);
        if (cardPriceEl) {
            cardPriceEl.textContent = `${data.ltp.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            cardPriceEl.classList.add(priceClass);
            setTimeout(() => cardPriceEl.classList.remove(priceClass), 300);
        }

        // Update P&L badge
        const pnlBadge = document.querySelector(`[data-symbol="${symbol}"] .pnl-badge`);
        if (pnlBadge) {
            if (isTrading) {
                const todayPct = data.change_pct || 0;
                const todaySign = todayPct >= 0 ? '+' : '';
                const todayClass = todayPct >= 0 ? 'profit' : 'loss';
                pnlBadge.textContent = `${todaySign}${todayPct.toFixed(2)}%`;
                pnlBadge.className = `pnl-badge ${todayClass}`;
            } else {
                const pnlSign = holding.is_profit ? '+' : '';
                pnlBadge.textContent = `${pnlSign}${holding.pnl_pct}%`;
                pnlBadge.className = `pnl-badge ${holding.is_profit ? 'profit' : 'loss'}`;
            }
        }

        // Update list view LTP
        const listPriceEl = document.querySelector(`.list-row[data-symbol="${symbol}"] .ltp-value`);
        if (listPriceEl) {
            listPriceEl.textContent = `${data.ltp.toFixed(0)}`;
            listPriceEl.classList.add(priceClass);
            setTimeout(() => listPriceEl.classList.remove(priceClass), 300);
        }

        // Update list P&L badge
        const listPnl = document.querySelector(`.list-row[data-symbol="${symbol}"] .list-pnl-badge`);
        if (listPnl) {
            const pnlSign = holding.is_profit ? '+' : '';
            listPnl.textContent = `${pnlSign}${holding.pnl_pct}%`;
            listPnl.className = `list-pnl-badge ${holding.is_profit ? 'profit' : 'loss'}`;
        }
    }

    // Subscribe to ticker after holdings are loaded
    function subscribeToTicker() {
        if (!socketConnected || !socket) return;

        const symbols = holdingsData.map(h => h.symbol);
        if (symbols.length > 0) {
            socket.emit('subscribe_ticker', { symbols: symbols });
        }
    }

    // Update portfolio summary
    function updateSummary(summary) {
        if (!summary) return;

        document.getElementById('stockCount').textContent = `${summary.stock_count} stocks in portfolio`;
        document.getElementById('totalInvested').textContent = formatCurrency(summary.total_invested);
        document.getElementById('totalCurrent').textContent = formatCurrency(summary.total_current);

        const pnlEl = document.getElementById('totalPnl');
        const pnlPctEl = document.getElementById('totalReturns');

        pnlEl.textContent = (summary.is_profit ? '+' : '') + formatCurrency(summary.total_pnl);
        pnlEl.className = `value ${summary.is_profit ? 'text-success' : 'text-danger'}`;

        pnlPctEl.textContent = (summary.is_profit ? '+' : '') + summary.total_pnl_pct + '%';
        pnlPctEl.className = `value ${summary.is_profit ? 'text-success' : 'text-danger'}`;

        // Calculate return milestone counts from holdingsData
        const count100Plus = holdingsData.filter(h => parseFloat(h.pnl_pct) >= 100).length;
        const count200Plus = holdingsData.filter(h => parseFloat(h.pnl_pct) >= 200).length;
        const count300Plus = holdingsData.filter(h => parseFloat(h.pnl_pct) >= 300).length;

        document.getElementById('count100Plus').textContent = count100Plus;
        document.getElementById('count200Plus').textContent = count200Plus;
        document.getElementById('count300Plus').textContent = count300Plus;
    }

    // Sort helper function
    function sortHoldings(data) {
        return [...data].sort((a, b) => {
            if (currentSort === 'alpha') {
                const aName = (a.name || a.symbol).toLowerCase();
                const bName = (b.name || b.symbol).toLowerCase();
                return sortAscending ? bName.localeCompare(aName) : aName.localeCompare(bName);
            }
            // Handle div_yield sorting from cached fundamentals
            if (currentSort === 'div_yield') {
                const aFund = getCachedData(`fund_${a.symbol}`) || {};
                const bFund = getCachedData(`fund_${b.symbol}`) || {};
                const aVal = aFund.div_yield || 0;
                const bVal = bFund.div_yield || 0;
                return sortAscending ? aVal - bVal : bVal - aVal;
            }
            const aVal = a[currentSort] || 0;
            const bVal = b[currentSort] || 0;
            return sortAscending ? aVal - bVal : bVal - aVal;
        });
    }

    // Render holding cards
    function renderHoldingCards() {
        const grid = document.getElementById('holdingsGrid');
        const isTrading = currentMode === 'trading';

        // Sort data
        const sorted = sortHoldings(holdingsData);

        // Find max current value for relative bar calculation
        const maxCurrent = Math.max(...holdingsData.map(h => h.current || 0));

        // Build HTML
        let html = '';
        sorted.forEach((h, idx) => {
            const pnlClass = h.is_profit ? 'profit' : 'loss';
            const pnlSign = h.is_profit ? '+' : '';
            const stockColor = getStockColor(h.symbol);
            // Bar width as percentage of max current value
            const barPct = maxCurrent > 0 ? ((h.current / maxCurrent) * 100).toFixed(1) : 0;

            // Trading data for this stock
            const td = tradingData[h.symbol] || {};
            const todayPct = td.today_pct || 0;
            const todayClass = todayPct >= 0 ? 'profit' : 'loss';
            const todaySign = todayPct >= 0 ? '+' : '';
            const cprStatus = td.cpr_status || 'N/A';
            const cprClass = cprStatus === 'Above CPR' ? 'above' : cprStatus === 'Below CPR' ? 'below' : '';
            const emaStatus = td.ema_status || 'N/A';
            const emaClass = emaStatus === 'Bullish' ? 'bullish' : emaStatus === 'Bearish' ? 'bearish' : 'neutral';
            // Today's P/L amount (quantity  day_change)
            const dayChange = td.day_change || 0;
            const todayPnL = dayChange * (h.quantity || 0);
            const dayHigh = td.day_high || 0;
            const dayLow = td.day_low || 0;

            html += `
                <div class="flip-card" data-symbol="${h.symbol}" data-sector="${h.sector}" onclick="flipCard(this)">
                    <div class="flip-card-inner">
                        <!-- Front -->
                        <div class="flip-card-front">
                            <div class="invest-bar" style="--invest-pct: ${barPct}%;"></div>
                            <div class="card-header-row">
                                <div class="stock-info">
                                    <div class="stock-logo" onclick="expandCard('${h.symbol}', event)" title="Click to expand" style="--logo-gradient: ${stockColor.gradient}; --logo-shadow: ${stockColor.shadow};">${h.logo}</div>
                                    <div>
                                        <div class="stock-name">${h.name || h.symbol}</div>
                                        <div class="stock-symbol">${h.symbol}</div>
                                    </div>
                                </div>
                                <div class="pnl-wrapper">
                                    ${isTrading ? `
                                        <span class="pnl-label">Today</span>
                                        <div class="pnl-badge ${todayClass}">${todaySign}${todayPct.toFixed(2)}%</div>
                                    ` : `
                                        <span class="pnl-label">P/L %</span>
                                        <div class="pnl-badge ${pnlClass}">${pnlSign}${h.pnl_pct}%</div>
                                    `}
                                </div>
                            </div>
                            <div class="metrics-row">
                                ${isTrading ? `
                                    <div class="metric-item">
                                        <div class="value ${todayClass}">${todaySign}${Math.abs(todayPnL).toFixed(0)}</div>
                                        <div class="label">Today P/L</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="cpr-badge ${cprClass}">${cprStatus}</span>
                                        <div class="label">W.CPR</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="ema-badge ${emaClass}">${emaStatus}</span>
                                        <div class="label">20/50 EMA</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="value" style="font-size: 0.8rem;">${dayLow.toFixed(0)} - ${dayHigh.toFixed(0)}</div>
                                        <div class="label">Day Range</div>
                                    </div>
                                ` : `
                                    <div class="metric-item"><div class="value">${formatCurrency(h.invested)}</div><div class="label">Invested</div></div>
                                    <div class="metric-item"><div class="value">${formatCurrency(h.current)}</div><div class="label">Current</div></div>
                                    <div class="metric-item"><div class="value ${h.is_profit ? 'text-success' : 'text-danger'}">${pnlSign}${formatCurrency(h.pnl)}</div><div class="label">P&L</div></div>
                                `}
                            </div>
                            <div class="chart-container"><canvas id="chart-${h.symbol}"></canvas></div>
                            <div class="extra-info-row">
                                <div class="info-badge dividend"><i class="bi bi-coin"></i> <span id="div-${h.symbol}">-</span></div>
                                <div class="info-badge"><i class="bi bi-pie-chart"></i> ${h.portfolio_pct}%</div>
                            </div>
                            <div class="flip-hint"><i class="bi bi-arrow-repeat"></i> Tap to flip</div>
                        </div>
                        <!-- Back -->
                        <div class="flip-card-back">
                            <div class="invest-bar" style="--invest-pct: ${barPct}%;"></div>
                            <div class="back-header">
                                <span class="back-title">${h.symbol} Fundamentals</span>
                                <span class="back-close"><i class="bi bi-arrow-repeat"></i></span>
                            </div>
                            <div class="fundamentals-row">
                                <div class="fund-box"><div class="title">Revenue 5Y</div><canvas id="rev-${h.symbol}"></canvas></div>
                                <div class="fund-box"><div class="title">Net Profit 5Y</div><canvas id="profit-${h.symbol}"></canvas></div>
                            </div>
                            <div class="ratios-row" id="ratios-${h.symbol}">
                                <!-- Populated when flipped -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        grid.innerHTML = html;

        // Load sparklines and fundamentals for each stock
        // In Trading mode, use intraday data; in Holdings mode, use 1Y data
        sorted.forEach(h => {
            if (isTrading) {
                loadIntradaySparkline(h.symbol, h.is_profit);
            } else {
                loadSparkline(h.symbol, h.is_profit);
            }
            loadCardFundamentals(h.symbol);
        });
    }

    // Load sparkline chart for a stock (with caching)
    async function loadSparkline(symbol, isProfit) {
        try {
            // Check cache first
            let prices = getCachedData(`hist_${symbol}`);

            if (!prices) {
                const response = await fetch(`/api/historical/${symbol}?period=1y`);
                if (!response.ok) return;

                const data = await response.json();
                if (!data.prices || data.prices.length === 0) return;

                prices = data.prices;
                setCachedData(`hist_${symbol}`, prices);
            }

            const ctx = document.getElementById(`chart-${symbol}`);
            if (!ctx) return;

            const color = isProfit ? '#22c55e' : '#ef4444';

            if (sparklineCharts[symbol]) {
                sparklineCharts[symbol].destroy();
            }

            sparklineCharts[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map((_, i) => i),
                    datasets: [{
                        data: prices,
                        borderColor: color,
                        borderWidth: 1.5,
                        fill: true,
                        backgroundColor: color + '15',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });

        } catch (error) {
            console.error(`Error loading sparkline for ${symbol}:`, error);
        }
    }

    // Load intraday sparkline chart for Trading mode (today's price movement)
    async function loadIntradaySparkline(symbol, isProfit) {
        try {
            // Use shorter cache key for intraday data
            let prices = getCachedData(`intraday_${symbol}`);

            if (!prices) {
                // Fetch intraday data (1 day, 5-minute intervals)
                const response = await fetch(`/api/historical/${symbol}?period=1d&interval=5m`);
                if (!response.ok) return;

                const data = await response.json();
                if (!data.prices || data.prices.length === 0) {
                    // Fallback to 1-day without interval if intraday fails
                    return loadSparkline(symbol, isProfit);
                }

                prices = data.prices;
                // Cache for 5 minutes only (intraday data changes frequently)
                setCachedData(`intraday_${symbol}`, prices, 5 * 60 * 1000);
            }

            const ctx = document.getElementById(`chart-${symbol}`);
            if (!ctx) return;

            // Color based on day performance (first vs last price)
            const dayProfit = prices.length > 1 && prices[prices.length - 1] >= prices[0];
            const color = dayProfit ? '#22c55e' : '#ef4444';

            if (sparklineCharts[symbol]) {
                sparklineCharts[symbol].destroy();
            }

            sparklineCharts[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map((_, i) => i),
                    datasets: [{
                        data: prices,
                        borderColor: color,
                        borderWidth: 1.5,
                        fill: true,
                        backgroundColor: color + '15',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });

        } catch (error) {
            console.error(`Error loading intraday sparkline for ${symbol}:`, error);
            // Fallback to daily chart
            loadSparkline(symbol, isProfit);
        }
    }

    // Load fundamentals for card back (with caching)
    async function loadCardFundamentals(symbol) {
        try {
            // Check cache first
            let data = getCachedData(`fund_${symbol}`);

            if (!data) {
                const response = await fetch(`/api/fundamentals/${symbol}`);
                if (!response.ok) return;

                data = await response.json();
                setCachedData(`fund_${symbol}`, data);
            }

            // Update dividend on front
            const divEl = document.getElementById(`div-${symbol}`);
            if (divEl) {
                divEl.textContent = data.div_yield ? `${data.div_yield}%` : '-';
            }

            // Update ratios on back
            const ratiosEl = document.getElementById(`ratios-${symbol}`);
            if (ratiosEl) {
                const deClass = data.de_ratio < 1 ? 'good' : data.de_ratio < 2 ? '' : 'warning';
                const peClass = data.pe_ratio < data.industry_pe ? 'good' : data.pe_ratio < data.industry_pe * 1.5 ? '' : 'warning';
                const roeClass = data.roe > 15 ? 'good' : '';

                ratiosEl.innerHTML = `
                    <div class="ratio-chip ${deClass}"><div class="value">${data.de_ratio.toFixed(2)}</div><div class="label">D/E</div></div>
                    <div class="ratio-chip ${peClass}"><div class="value">${data.pe_ratio.toFixed(1)}</div><div class="label">P/E</div></div>
                    <div class="ratio-chip ${roeClass}"><div class="value">${data.roe.toFixed(1)}%</div><div class="label">ROE</div></div>
                    <div class="ratio-chip"><div class="value">${data.roce.toFixed(1)}%</div><div class="label">ROCE</div></div>
                `;
            }

        } catch (error) {
            console.error(`Error loading fundamentals for ${symbol}:`, error);
        }
    }

    // Flip card
    function flipCard(card) {
        card.classList.toggle('flipped');
    }

    // Get sorted holdings list (same order as displayed)
    function getSortedHoldings() {
        return [...holdingsData].sort((a, b) => {
            const aVal = a[currentSort] || 0;
            const bVal = b[currentSort] || 0;
            return sortAscending ? aVal - bVal : bVal - aVal;
        });
    }

    // Expand card to modal
    async function expandCard(symbol, event) {
        event.stopPropagation();
        document.getElementById('expandedOverlay').classList.add('active');

        // Find holding data and index in sorted list
        const sortedHoldings = getSortedHoldings();
        currentExpandedIndex = sortedHoldings.findIndex(h => h.symbol === symbol);
        const holding = sortedHoldings[currentExpandedIndex];
        if (!holding) return;

        // Update counter
        document.getElementById('exp-counter').textContent = ` (${currentExpandedIndex + 1}/${sortedHoldings.length})`;

        // Update basic info with consistent color
        const stockColor = getStockColor(symbol);
        const logoEl = document.getElementById('exp-logo');
        logoEl.textContent = holding.logo;
        logoEl.style.setProperty('--logo-gradient', stockColor.gradient);
        logoEl.style.setProperty('--logo-shadow', stockColor.shadow);
        const nameEl = document.getElementById('exp-name');
        nameEl.innerHTML = `${holding.name || symbol}<span class="stock-counter" id="exp-counter"> (${currentExpandedIndex + 1}/${sortedHoldings.length})</span>`;
        document.getElementById('exp-symbol').textContent = symbol;
        document.getElementById('exp-invested').textContent = formatCurrency(holding.invested);
        document.getElementById('exp-current').textContent = formatCurrency(holding.current);

        const pnlSign = holding.is_profit ? '+' : '';
        document.getElementById('exp-pnl').textContent = pnlSign + formatCurrency(holding.pnl);
        document.getElementById('exp-pnl').className = `value ${holding.is_profit ? 'text-success' : 'text-danger'}`;
        document.getElementById('exp-pnl-pct').textContent = pnlSign + holding.pnl_pct + '%';
        document.getElementById('exp-pnl-pct').className = `value ${holding.is_profit ? 'text-success' : 'text-danger'}`;

        // Update portfolio bar
        const currentPct = holding.current_pct || holding.portfolio_pct || 0;
        document.getElementById('exp-portfolio-bar').style.setProperty('--invest-pct', currentPct + '%');
        document.getElementById('exp-portfolio-pct').textContent = currentPct + '% of portfolio';

        // Load fundamentals and price data (with caching)
        try {
            // Check cache first
            let fundData = getCachedData(`fund_${symbol}`);
            let prices = getCachedData(`hist_${symbol}`);

            // Fetch only missing data
            const promises = [];
            if (!fundData) {
                promises.push(fetch(`/api/fundamentals/${symbol}`).then(r => r.json()).then(d => { fundData = d; setCachedData(`fund_${symbol}`, d); }));
            }
            if (!prices) {
                promises.push(fetch(`/api/historical/${symbol}?period=1y`).then(r => r.json()).then(d => { prices = d.prices || []; setCachedData(`hist_${symbol}`, prices); }));
            }

            if (promises.length > 0) {
                await Promise.all(promises);
            }

            populateExpandedView(holding, fundData, prices || []);

        } catch (error) {
            console.error(`Error loading expanded view for ${symbol}:`, error);
        }
    }

    // Pre-fetch all data for faster subsequent loads
    async function prefetchAllData() {
        if (!holdingsData.length) return;

        console.log('Pre-fetching data for all holdings...');
        const symbols = holdingsData.map(h => h.symbol);

        // Batch fetch fundamentals and historical data
        for (const symbol of symbols) {
            // Skip if already cached
            if (getCachedData(`fund_${symbol}`) && getCachedData(`hist_${symbol}`)) continue;

            // Fetch with small delay to avoid overwhelming server
            try {
                if (!getCachedData(`fund_${symbol}`)) {
                    const fundResp = await fetch(`/api/fundamentals/${symbol}`);
                    const fundData = await fundResp.json();
                    setCachedData(`fund_${symbol}`, fundData);
                }
                if (!getCachedData(`hist_${symbol}`)) {
                    const histResp = await fetch(`/api/historical/${symbol}?period=1y`);
                    const histData = await histResp.json();
                    setCachedData(`hist_${symbol}`, histData.prices || []);
                }
            } catch (e) {
                console.warn(`Failed to prefetch for ${symbol}:`, e);
            }
        }
        console.log('Pre-fetch complete');
    }

    // Navigate to previous/next stock in expanded view
    function navigateStock(direction) {
        const sortedHoldings = getSortedHoldings();
        if (sortedHoldings.length === 0) return;

        // Calculate new index with wrapping
        currentExpandedIndex = (currentExpandedIndex + direction + sortedHoldings.length) % sortedHoldings.length;
        const newHolding = sortedHoldings[currentExpandedIndex];

        // Load the new stock
        loadExpandedStock(newHolding, currentExpandedIndex, sortedHoldings.length);
    }

    // Load a specific stock into expanded view
    async function loadExpandedStock(holding, index, total) {
        const symbol = holding.symbol;

        // Update basic info with consistent color
        const stockColor = getStockColor(symbol);
        const logoEl = document.getElementById('exp-logo');
        logoEl.textContent = holding.logo;
        logoEl.style.setProperty('--logo-gradient', stockColor.gradient);
        logoEl.style.setProperty('--logo-shadow', stockColor.shadow);
        const nameEl = document.getElementById('exp-name');
        nameEl.innerHTML = `${holding.name || symbol}<span class="stock-counter"> (${index + 1}/${total})</span>`;
        document.getElementById('exp-symbol').textContent = symbol;
        document.getElementById('exp-invested').textContent = formatCurrency(holding.invested);
        document.getElementById('exp-current').textContent = formatCurrency(holding.current);

        const pnlSign = holding.is_profit ? '+' : '';
        document.getElementById('exp-pnl').textContent = pnlSign + formatCurrency(holding.pnl);
        document.getElementById('exp-pnl').className = `value ${holding.is_profit ? 'text-success' : 'text-danger'}`;
        document.getElementById('exp-pnl-pct').textContent = pnlSign + holding.pnl_pct + '%';
        document.getElementById('exp-pnl-pct').className = `value ${holding.is_profit ? 'text-success' : 'text-danger'}`;

        // Update portfolio bar
        const currentPct = holding.current_pct || holding.portfolio_pct || 0;
        document.getElementById('exp-portfolio-bar').style.setProperty('--invest-pct', currentPct + '%');
        document.getElementById('exp-portfolio-pct').textContent = currentPct + '% of portfolio';

        // Load fundamentals and price data (with caching)
        try {
            let fundData = getCachedData(`fund_${symbol}`);
            let prices = getCachedData(`hist_${symbol}`);

            const promises = [];
            if (!fundData) {
                promises.push(fetch(`/api/fundamentals/${symbol}`).then(r => r.json()).then(d => { fundData = d; setCachedData(`fund_${symbol}`, d); }));
            }
            if (!prices) {
                promises.push(fetch(`/api/historical/${symbol}?period=1y`).then(r => r.json()).then(d => { prices = d.prices || []; setCachedData(`hist_${symbol}`, prices); }));
            }

            if (promises.length > 0) {
                await Promise.all(promises);
            }

            populateExpandedView(holding, fundData, prices || []);
        } catch (error) {
            console.error(`Error loading expanded view for ${symbol}:`, error);
        }
    }

    // Open share modal with screenshot
    async function openShareModal() {
        const shareModal = document.getElementById('shareModal');
        const sharePreview = document.getElementById('sharePreview');
        const expandedCard = document.getElementById('expandedCard');

        shareModal.classList.add('active');
        sharePreview.innerHTML = '<p class="text-secondary text-center py-4"><i class="bi bi-hourglass-split"></i> Generating preview...</p>';

        try {
            // Generate screenshot
            const canvas = await html2canvas(expandedCard, {
                backgroundColor: '#1e293b',
                scale: 2,
                logging: false
            });

            const imgData = canvas.toDataURL('image/png');
            sharePreview.innerHTML = `<img src="${imgData}" alt="Stock preview" id="shareImage">`;

            // Pre-fill commentary with stock info
            const sortedHoldings = getSortedHoldings();
            const holding = sortedHoldings[currentExpandedIndex];
            if (holding) {
                const sign = holding.is_profit ? '+' : '';
                document.getElementById('shareCommentary').value =
                    `${holding.name} (${holding.symbol})\n` +
                    `Returns: ${sign}${holding.pnl_pct}%\n` +
                    `P&L: ${sign}${formatCurrency(holding.pnl)}`;
            }
        } catch (error) {
            console.error('Error generating screenshot:', error);
            sharePreview.innerHTML = '<p class="text-danger text-center py-4">Failed to generate preview</p>';
        }
    }

    // Close share modal
    function closeShareModal(event) {
        if (event.target === document.getElementById('shareModal') || event.target.closest('.cancel')) {
            document.getElementById('shareModal').classList.remove('active');
        }
    }

    // Share to WhatsApp
    function shareToWhatsApp() {
        const commentary = document.getElementById('shareCommentary').value;
        const shareImage = document.getElementById('shareImage');

        // WhatsApp doesn't support direct image sharing via URL, so we share text with link
        const sortedHoldings = getSortedHoldings();
        const holding = sortedHoldings[currentExpandedIndex];

        let message = commentary || '';
        if (holding) {
            message = message || `Check out my ${holding.symbol} position!\nReturns: ${holding.is_profit ? '+' : ''}${holding.pnl_pct}%`;
        }

        // Encode and open WhatsApp
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        // If we have an image, also trigger download so user can attach
        if (shareImage) {
            const link = document.createElement('a');
            link.download = `${holding ? holding.symbol : 'stock'}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = shareImage.src;
            link.click();
        }

        closeShareModal({ target: document.getElementById('shareModal') });
    }

    // Open full screen detailed view
    function openFullScreen() {
        const sortedHoldings = getSortedHoldings();
        const holding = sortedHoldings[currentExpandedIndex];
        if (!holding) return;

        // Open in new tab with symbol parameter
        window.open(`/holdings/detail/${holding.symbol}`, '_blank');
    }

    // Populate expanded view with data
    function populateExpandedView(holding, fundData, prices) {
        // Update overview
        document.getElementById('exp-overview').textContent = fundData.description || holding.description || '';

        // Update dividend info
        document.getElementById('exp-div-yield').textContent = fundData.div_yield ? `${fundData.div_yield}%` : '-';
        document.getElementById('exp-div-date').textContent = fundData.next_div_date || 'TBA';

        // Update ratios
        const ratiosHtml = `
            <div class="exp-ratio"><div class="value">${fundData.de_ratio.toFixed(2)}</div><div class="label">D/E Ratio</div></div>
            <div class="exp-ratio"><div class="value">${fundData.pe_ratio.toFixed(1)} <span class="text-secondary">/</span> <span class="industry-pe">${fundData.industry_pe.toFixed(1)}</span></div><div class="label">P/E (Stock / Industry)</div></div>
            <div class="exp-ratio"><div class="value">${fundData.roe.toFixed(1)}%</div><div class="label">ROE</div></div>
            <div class="exp-ratio"><div class="value">${fundData.roce.toFixed(1)}%</div><div class="label">ROCE</div></div>
        `;
        document.getElementById('exp-ratios').innerHTML = ratiosHtml;

        // Destroy existing charts
        if (expChartInstance) { expChartInstance.destroy(); expChartInstance = null; }
        if (expRevenueInstance) { expRevenueInstance.destroy(); expRevenueInstance = null; }
        if (expProfitInstance) { expProfitInstance.destroy(); expProfitInstance = null; }
        if (expOpmInstance) { expOpmInstance.destroy(); expOpmInstance = null; }

        // Create price chart
        if (prices.length > 0) {
            const chartCtx = document.getElementById('exp-chart');
            const color = holding.is_profit ? '#22c55e' : '#ef4444';
            expChartInstance = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: prices.map((_, i) => i),
                    datasets: [{
                        data: prices,
                        borderColor: color,
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: color + '20',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // Generate dynamic chart labels based on data length
        function getChartLabels(dataArray) {
            const currentYear = new Date().getFullYear();
            const len = dataArray.length || 0;
            const labels = [];
            for (let i = len - 1; i >= 0; i--) {
                labels.unshift(`FY${(currentYear - i).toString().slice(-2)}`);
            }
            return labels;
        }
        const chartLabels = getChartLabels(fundData.revenue_5y || []);

        // Revenue chart - only create if we have valid data
        const revenueData = fundData.revenue_5y || [];
        const revCtx = document.getElementById('exp-revenue');
        if (revenueData.length > 0 && revenueData.some(v => v > 0)) {
            const revLabels = getChartLabels(revenueData);
            expRevenueInstance = new Chart(revCtx, {
                type: 'bar',
                data: {
                    labels: revLabels,
                    datasets: [{
                        type: 'bar',
                        data: revenueData,
                        backgroundColor: '#3b82f690',
                        borderRadius: 6,
                        order: 2
                    }, {
                        type: 'line',
                        data: revenueData,
                        borderColor: '#fbbf24',
                        borderWidth: 2,
                        pointBackgroundColor: '#fbbf24',
                        pointRadius: 3,
                        tension: 0.3,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 8 } } },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.08)' }, ticks: { color: '#64748b', font: { size: 8 }, maxTicksLimit: 4 } }
                    }
                }
            });
        } else {
            // Show "No data" message
            revCtx.parentElement.innerHTML = '<div class="title">Revenue (Cr)</div><div class="text-secondary text-center py-4" style="font-size: 0.7rem;">Data not available</div>';
        }

        // Profit chart - only create if we have valid data
        const profitData = fundData.profit_5y || [];
        const profitCtx = document.getElementById('exp-profit');
        if (profitData.length > 0 && profitData.some(v => v !== 0)) {
            const profitLabels = getChartLabels(profitData);
            expProfitInstance = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: profitLabels,
                    datasets: [{
                        type: 'bar',
                        data: profitData,
                        backgroundColor: profitData.map(v => v >= 0 ? '#22c55e90' : '#ef444490'),
                        borderRadius: 6,
                        order: 2
                    }, {
                        type: 'line',
                        data: profitData,
                        borderColor: '#fbbf24',
                        borderWidth: 2,
                        pointBackgroundColor: '#fbbf24',
                        pointRadius: 3,
                        tension: 0.3,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 8 } } },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.08)' }, ticks: { color: '#64748b', font: { size: 8 }, maxTicksLimit: 4 } }
                    }
                }
            });
        } else {
            profitCtx.parentElement.innerHTML = '<div class="title">Net Profit (Cr)</div><div class="text-secondary text-center py-4" style="font-size: 0.7rem;">Data not available</div>';
        }

        // OPM chart - only create if we have valid data
        const opmData = fundData.opm_5y || [];
        const opmCtx = document.getElementById('exp-opm');
        if (opmData.length > 0 && opmData.some(v => v > 0)) {
            const opmLabels = getChartLabels(opmData);
            expOpmInstance = new Chart(opmCtx, {
                type: 'bar',
                data: {
                    labels: opmLabels,
                    datasets: [{
                        type: 'bar',
                        data: opmData,
                        backgroundColor: '#f59e0b90',
                        borderRadius: 6,
                        order: 2
                    }, {
                        type: 'line',
                        data: opmData,
                        borderColor: '#a78bfa',
                        borderWidth: 2,
                        pointBackgroundColor: '#a78bfa',
                        pointRadius: 3,
                        tension: 0.3,
                        fill: false,
                        order: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 8 } } },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.08)' }, ticks: { color: '#64748b', font: { size: 8 }, maxTicksLimit: 4, callback: v => v + '%' } }
                    }
                }
            });
        } else {
            opmCtx.parentElement.innerHTML = '<div class="title">OPM %</div><div class="text-secondary text-center py-4" style="font-size: 0.7rem;">Data not available</div>';
        }
    }

    // Close expanded view
    function closeExpanded(event) {
        if (event.target === document.getElementById('expandedOverlay') || event.target.closest('.close-btn')) {
            document.getElementById('expandedOverlay').classList.remove('active');
        }
    }

    // Switch mode (holdings/trading)
    function switchMode(mode) {
        currentMode = mode;

        // Update button states
        document.querySelectorAll('.mode-toggle button').forEach(btn => {
            const isActive = btn.dataset.mode === mode;
            btn.classList.toggle('active', isActive);
            if (mode === 'trading' && isActive) {
                btn.classList.add('trading');
            } else {
                btn.classList.remove('trading');
            }
        });

        // Apply trading mode class to grid/list
        document.getElementById('holdingsGrid').classList.toggle('trading-mode', mode === 'trading');
        document.getElementById('listView').classList.toggle('trading-mode', mode === 'trading');

        // If trading mode and data not loaded, start loading
        if (mode === 'trading' && !tradingDataLoaded) {
            loadTradingDataInBackground();
        }

        // Re-render current view
        if (currentView === 'grid') {
            renderHoldingCards();
        } else if (currentView === 'list') {
            renderListView();
        } else if (currentView === 'sector') {
            renderSectorView();
        }
    }

    // Load trading data in background (CPR, EMA, today's %)
    async function loadTradingDataInBackground() {
        if (tradingDataLoaded) return;

        const loadingDot = document.getElementById('tradingLoadingDot');
        loadingDot.style.display = 'inline-block';

        try {
            const symbols = holdingsData.map(h => h.symbol);
            const response = await fetch('/api/trading-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbols })
            });

            if (response.ok) {
                const data = await response.json();
                tradingData = data.trading_data || {};
                tradingDataLoaded = true;

                // Re-render if still in trading mode
                if (currentMode === 'trading') {
                    if (currentView === 'grid') {
                        renderHoldingCards();
                    } else if (currentView === 'list') {
                        renderListView();
                    }
                }
            }
        } catch (error) {
            console.error('Error loading trading data:', error);
        } finally {
            loadingDot.style.display = 'none';
        }
    }

    // Switch view (grid/list/sector)
    function switchView(viewType) {
        currentView = viewType;

        document.querySelectorAll('.view-toggle button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === viewType);
        });

        const gridView = document.getElementById('holdingsGrid');
        const listView = document.getElementById('listView');
        const sectorView = document.getElementById('sector-view');

        gridView.style.display = 'none';
        listView.style.display = 'none';
        sectorView.style.display = 'none';

        if (viewType === 'grid') {
            gridView.style.display = 'grid';
        } else if (viewType === 'list') {
            listView.style.display = 'flex';
            renderListView();
        } else if (viewType === 'sector') {
            sectorView.style.display = 'block';
            renderSectorView();
        }
    }

    // Render list view
    function renderListView() {
        // Clean up existing list charts before re-rendering
        Object.keys(listDayCharts).forEach(sym => {
            if (listDayCharts[sym]) {
                listDayCharts[sym].destroy();
            }
        });
        Object.keys(list1YCharts).forEach(sym => {
            if (list1YCharts[sym]) {
                list1YCharts[sym].destroy();
            }
        });
        listDayCharts = {};
        list1YCharts = {};

        const listView = document.getElementById('listView');
        const isTrading = currentMode === 'trading';

        // Sort data
        const sorted = sortHoldings(holdingsData);

        // Group by profit/loss for partition
        const profitable = sorted.filter(h => h.is_profit);
        const losing = sorted.filter(h => !h.is_profit);

        let html = '';

        // Profitable section
        if (profitable.length > 0) {
            html += `
                <div class="list-section">
                    <div class="list-section-header">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        Profitable (${profitable.length})  Total: ${formatCurrency(profitable.reduce((sum, h) => sum + h.pnl, 0))}
                    </div>
                    <div class="list-items">
                        ${profitable.map(h => createListRowHtml(h, isTrading)).join('')}
                    </div>
                </div>
            `;
        }

        // Loss section
        if (losing.length > 0) {
            html += `
                <div class="list-section">
                    <div class="list-section-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.1)); border-color: rgba(239, 68, 68, 0.3);">
                        <i class="bi bi-graph-down-arrow me-2" style="color: #ef4444;"></i>
                        <span style="color: #f87171;">In Loss (${losing.length})  Total: ${formatCurrency(losing.reduce((sum, h) => sum + h.pnl, 0))}</span>
                    </div>
                    <div class="list-items">
                        ${losing.map(h => createListRowHtml(h, isTrading)).join('')}
                    </div>
                </div>
            `;
        }

        listView.innerHTML = html;

        // Render mini charts and load div yields for list view
        sorted.forEach(h => {
            loadListDivYield(h.symbol);
            loadDayTicker(h.symbol);
            load1YTicker(h.symbol, h.is_profit);
        });
    }

    // Load dividend yield from cached fundamentals for list view
    function loadListDivYield(symbol) {
        const el = document.getElementById(`list-div-${symbol}`);
        if (!el) return;

        // Try to get from cached fundamentals
        const cached = getCachedData(`fund_${symbol}`);
        if (cached && cached.div_yield) {
            el.textContent = cached.div_yield.toFixed(2) + '%';
        } else {
            // Load fundamentals if not cached
            fetch(`/api/fundamentals/${symbol}`)
                .then(r => r.json())
                .then(data => {
                    setCachedData(`fund_${symbol}`, data);
                    if (data.div_yield) {
                        el.textContent = data.div_yield.toFixed(2) + '%';
                    }
                })
                .catch(() => {});
        }
    }

    // Create list row HTML
    function createListRowHtml(h, isTrading) {
        const pnlClass = h.is_profit ? 'profit' : 'loss';
        const pnlSign = h.is_profit ? '+' : '';
        const stockColor = getStockColor(h.symbol);
        const td = tradingData[h.symbol] || {};

        if (isTrading) {
            // Trading mode: Today's %, CPR, EMA, Price
            const todayPct = td.today_pct || 0;
            const todayClass = todayPct >= 0 ? 'profit' : 'loss';
            const todaySign = todayPct >= 0 ? '+' : '';
            const cprStatus = td.cpr_status || 'N/A';
            const cprClass = cprStatus === 'Above CPR' ? 'above' : cprStatus === 'Below CPR' ? 'below' : '';
            const emaStatus = td.ema_status || 'N/A';
            const emaClass = emaStatus === 'Bullish' ? 'bullish' : emaStatus === 'Bearish' ? 'bearish' : 'neutral';

            return `
                <div class="list-row" onclick="expandCard('${h.symbol}', event)">
                    <div class="list-stock-info">
                        <div class="list-stock-logo" style="background: ${stockColor.gradient};">${h.logo}</div>
                        <div>
                            <div class="list-stock-name">${h.name || h.symbol}</div>
                            <div class="list-stock-symbol">${h.symbol}</div>
                        </div>
                    </div>
                    <div class="list-metrics">
                        <div class="list-metric">
                            <div class="value">${(td.ltp || h.last_price || 0).toFixed(2)}</div>
                            <div class="label">Price</div>
                        </div>
                        <div class="list-metric">
                            <span class="cpr-badge ${cprClass}">${cprStatus}</span>
                            <div class="label">W.CPR</div>
                        </div>
                        <div class="list-metric">
                            <span class="ema-badge ${emaClass}">${emaStatus}</span>
                            <div class="label">20/50 EMA</div>
                        </div>
                    </div>
                    <div class="list-pnl-badge ${todayClass}">${todaySign}${todayPct.toFixed(2)}%</div>
                    <div class="list-sparkline"><canvas id="list-chart-${h.symbol}"></canvas></div>
                    <div class="list-actions">
                        <button class="list-action-btn" onclick="expandCard('${h.symbol}', event)" title="View Details"><i class="bi bi-arrows-fullscreen"></i></button>
                    </div>
                </div>
            `;
        } else {
            // Holdings mode: Invested, Current, P&L + LTP/Avg with day ticker + Div Yield + 1Y ticker
            // Get today's change data
            const todayPct = td.today_pct || 0;
            const ltpClass = todayPct >= 0 ? 'text-success' : 'text-danger';
            const ltpSign = todayPct >= 0 ? '+' : '';

            return `
                <div class="list-row" onclick="expandCard('${h.symbol}', event)">
                    <div class="list-stock-info">
                        <div class="list-stock-logo" style="background: ${stockColor.gradient};">${h.logo}</div>
                        <div>
                            <div class="list-stock-name">${h.name || h.symbol}</div>
                            <div class="list-stock-symbol">${h.symbol}</div>
                            <div class="list-stock-sector">${h.sector}</div>
                        </div>
                    </div>
                    <div class="list-metrics">
                        <div class="list-metric">
                            <div class="value large">${formatCurrency(h.invested)}</div>
                            <div class="label">Invested</div>
                            <div class="sub-value">${h.quantity} shares</div>
                        </div>
                        <div class="list-metric">
                            <div class="value large">${formatCurrency(h.current)}</div>
                            <div class="label">Current</div>
                            <div class="sub-value">${h.portfolio_pct || 0}% of portfolio</div>
                        </div>
                        <div class="list-metric">
                            <div class="value large ${h.is_profit ? 'text-success' : 'text-danger'}">${pnlSign}${formatCurrency(h.pnl)} <span class="pnl-pct-inline">(${pnlSign}${h.pnl_pct}%)</span></div>
                            <div class="label">P&L</div>
                        </div>
                        <div class="list-metric">
                            <div class="ltp-avg-container">
                                <div class="ltp-value ${ltpClass}">${h.last_price ? h.last_price.toFixed(0) : '-'}</div>
                                <div class="ltp-divider"></div>
                                <div class="avg-value">${h.average_price ? h.average_price.toFixed(0) : '-'}</div>
                            </div>
                            <div class="label">LTP / Avg</div>
                        </div>
                        <div class="list-metric">
                            <div class="ticker-container">
                                <canvas id="list-day-chart-${h.symbol}" class="mini-ticker"></canvas>
                                <div class="mini-ticker-label">Day</div>
                            </div>
                        </div>
                        <div class="list-metric">
                            <div class="value" id="list-div-${h.symbol}">-</div>
                            <div class="label">Div Yield</div>
                        </div>
                        <div class="list-metric">
                            <div class="ticker-container">
                                <canvas id="list-1y-chart-${h.symbol}" class="mini-ticker"></canvas>
                                <div class="mini-ticker-label">1Y</div>
                            </div>
                        </div>
                    </div>
                    <button class="list-action-btn" onclick="expandCard('${h.symbol}', event)" title="View Details"><i class="bi bi-arrows-fullscreen"></i></button>
                </div>
            `;
        }
    }

    // Load sparkline for list view
    async function loadListSparkline(symbol, isProfit) {
        try {
            let prices = getCachedData(`hist_${symbol}`);
            if (!prices) return;  // Only use cached data for list sparklines

            const ctx = document.getElementById(`list-chart-${symbol}`);
            if (!ctx) return;

            const color = isProfit ? '#22c55e' : '#ef4444';

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.slice(-30).map((_, i) => i),  // Last 30 days
                    datasets: [{
                        data: prices.slice(-30),
                        borderColor: color,
                        borderWidth: 1,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        } catch (error) {
            console.error(`Error loading list sparkline for ${symbol}:`, error);
        }
    }

    // Load day ticker chart for list view
    async function loadDayTicker(symbol) {
        try {
            // Get intraday data from trading data or fetch it
            const td = tradingData[symbol];
            const todayPct = td?.today_pct || 0;
            const color = todayPct >= 0 ? '#22c55e' : '#ef4444';

            const ctx = document.getElementById(`list-day-chart-${symbol}`);
            if (!ctx) return;

            // Destroy existing chart if any
            if (listDayCharts[symbol]) {
                listDayCharts[symbol].destroy();
                listDayCharts[symbol] = null;
            }

            // Use cached 1Y data and take last day's hourly approximation
            // Or generate simple trend line based on today's movement
            let prices = getCachedData(`hist_${symbol}`);
            if (prices && prices.length > 1) {
                // Use last 5 data points as proxy for day movement
                const dayData = prices.slice(-5);
                listDayCharts[symbol] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dayData.map((_, i) => i),
                        datasets: [{
                            data: dayData,
                            borderColor: color,
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            }
        } catch (error) {
            console.error(`Error loading day ticker for ${symbol}:`, error);
        }
    }

    // Load 1Y ticker chart for list view
    async function load1YTicker(symbol, isProfit) {
        try {
            let prices = getCachedData(`hist_${symbol}`);
            if (!prices || prices.length < 10) return;

            const ctx = document.getElementById(`list-1y-chart-${symbol}`);
            if (!ctx) return;

            // Destroy existing chart if any
            if (list1YCharts[symbol]) {
                list1YCharts[symbol].destroy();
                list1YCharts[symbol] = null;
            }

            const color = isProfit ? '#22c55e' : '#ef4444';

            // Sample data for smoother chart (every 5th point for 1Y)
            const sampledPrices = prices.filter((_, i) => i % 5 === 0 || i === prices.length - 1);

            list1YCharts[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledPrices.map((_, i) => i),
                    datasets: [{
                        data: sampledPrices,
                        borderColor: color,
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        } catch (error) {
            console.error(`Error loading 1Y ticker for ${symbol}:`, error);
        }
    }

    // Render sector view
    function renderSectorView() {
        const sectorView = document.getElementById('sector-view');
        const isTrading = currentMode === 'trading';

        // Find max current value for relative bar calculation
        const maxCurrent = Math.max(...holdingsData.map(h => h.current || 0));

        // Group by sector
        const sectors = {};
        holdingsData.forEach(h => {
            if (!sectors[h.sector]) {
                sectors[h.sector] = { name: h.sector, stocks: [], invested: 0, current: 0, pnl: 0 };
            }
            sectors[h.sector].stocks.push(h);
            sectors[h.sector].invested += h.invested;
            sectors[h.sector].current += h.current;
            sectors[h.sector].pnl += h.pnl;
        });

        // Calculate pnl_pct for each sector
        Object.values(sectors).forEach(s => {
            s.pnl_pct = s.invested > 0 ? (s.pnl / s.invested * 100) : 0;
        });

        // Sort sectors: by selected metric, with "Other" always last
        let sortedSectors = Object.values(sectors).sort((a, b) => {
            // "Other" always last
            if (a.name === 'Other') return 1;
            if (b.name === 'Other') return -1;

            // Alphabetical sort
            if (currentSort === 'alpha') {
                return sortAscending ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name);
            }

            // Sort by sector totals
            const aVal = a[currentSort] || 0;
            const bVal = b[currentSort] || 0;
            return sortAscending ? aVal - bVal : bVal - aVal;
        });

        // Build HTML
        let html = '';
        sortedSectors.forEach(data => {
            const sector = data.name;
            const pnlPct = data.pnl_pct.toFixed(1);
            const isProfit = data.pnl >= 0;

            // Sort stocks within sector
            const sortedStocks = sortHoldings(data.stocks);

            html += `
                <div class="sector-group">
                    <div class="sector-header" onclick="toggleSector(this)">
                        <div class="sector-name">
                            <i class="bi bi-chevron-down sector-toggle"></i>
                            ${sector} <span class="sector-count">${data.stocks.length} stock${data.stocks.length > 1 ? 's' : ''}</span>
                        </div>
                        <div class="sector-stats">
                            <div class="sector-stat"><div class="value">${formatCurrency(data.invested)}</div><div class="label">Invested</div></div>
                            <div class="sector-stat"><div class="value">${formatCurrency(data.current)}</div><div class="label">Current</div></div>
                            <div class="sector-stat"><div class="value ${isProfit ? 'text-success' : 'text-danger'}">${isProfit ? '+' : ''}${formatCurrency(data.pnl)}</div><div class="label">P&L</div></div>
                            <div class="sector-stat"><div class="value ${isProfit ? 'text-success' : 'text-danger'}">${isProfit ? '+' : ''}${pnlPct}%</div><div class="label">Returns</div></div>
                        </div>
                    </div>
                    <div class="sector-content">
                        <div class="sector-grid">
                            ${sortedStocks.map(h => createSectorCardHtml(h, maxCurrent, isTrading)).join('')}
                        </div>
                    </div>
                </div>
            `;
        });

        sectorView.innerHTML = html;

        // Load sparklines for all sector cards
        // In Trading mode, use intraday data; in Holdings mode, use 1Y data
        holdingsData.forEach(h => {
            loadSectorSparkline(h.symbol, h.is_profit, isTrading);
        });
    }

    // Create card HTML (for sector view with charts)
    function createSectorCardHtml(h, maxCurrent, isTrading) {
        const pnlClass = h.is_profit ? 'profit' : 'loss';
        const pnlSign = h.is_profit ? '+' : '';
        const stockColor = getStockColor(h.symbol);
        const barPct = maxCurrent > 0 ? ((h.current / maxCurrent) * 100).toFixed(1) : 0;
        const td = tradingData[h.symbol] || {};
        const todayPct = td.today_pct || 0;
        const todayClass = todayPct >= 0 ? 'profit' : 'loss';
        const todaySign = todayPct >= 0 ? '+' : '';
        const cprStatus = td.cpr_status || 'N/A';
        const cprClass = cprStatus === 'Above CPR' ? 'above' : cprStatus === 'Below CPR' ? 'below' : '';
        const emaStatus = td.ema_status || 'N/A';
        const emaClass = emaStatus === 'Bullish' ? 'bullish' : emaStatus === 'Bearish' ? 'bearish' : 'neutral';
        // Today's P/L amount (quantity  day_change)
        const dayChange = td.day_change || 0;
        const todayPnL = dayChange * (h.quantity || 0);
        const dayHigh = td.day_high || 0;
        const dayLow = td.day_low || 0;

        return `
            <div class="flip-card" data-symbol="${h.symbol}" onclick="flipCard(this)">
                <div class="flip-card-inner">
                    <div class="flip-card-front">
                        <div class="invest-bar" style="--invest-pct: ${barPct}%;"></div>
                        <div class="card-header-row">
                            <div class="stock-info">
                                <div class="stock-logo" onclick="expandCard('${h.symbol}', event)" style="--logo-gradient: ${stockColor.gradient}; --logo-shadow: ${stockColor.shadow};">${h.logo}</div>
                                <div>
                                    <div class="stock-name">${h.name || h.symbol}</div>
                                    <div class="stock-symbol">${h.symbol}</div>
                                </div>
                            </div>
                            <div class="pnl-wrapper">
                                ${isTrading ? `
                                    <span class="pnl-label">Today</span>
                                    <div class="pnl-badge ${todayClass}">${todaySign}${todayPct.toFixed(2)}%</div>
                                ` : `
                                    <span class="pnl-label">P/L %</span>
                                    <div class="pnl-badge ${pnlClass}">${pnlSign}${h.pnl_pct}%</div>
                                `}
                            </div>
                        </div>
                        <div class="metrics-row">
                            ${isTrading ? `
                                <div class="metric-item">
                                    <div class="value ${todayClass}">${todaySign}${Math.abs(todayPnL).toFixed(0)}</div>
                                    <div class="label">Today P/L</div>
                                </div>
                                <div class="metric-item">
                                    <span class="cpr-badge ${cprClass}">${cprStatus}</span>
                                    <div class="label">W.CPR</div>
                                </div>
                                <div class="metric-item">
                                    <span class="ema-badge ${emaClass}">${emaStatus}</span>
                                    <div class="label">20/50 EMA</div>
                                </div>
                                <div class="metric-item">
                                    <div class="value" style="font-size: 0.8rem;">${dayLow.toFixed(0)} - ${dayHigh.toFixed(0)}</div>
                                    <div class="label">Day Range</div>
                                </div>
                            ` : `
                                <div class="metric-item"><div class="value">${formatCurrency(h.invested)}</div><div class="label">Invested</div></div>
                                <div class="metric-item"><div class="value">${formatCurrency(h.current)}</div><div class="label">Current</div></div>
                                <div class="metric-item"><div class="value ${h.is_profit ? 'text-success' : 'text-danger'}">${pnlSign}${formatCurrency(h.pnl)}</div><div class="label">P&L</div></div>
                            `}
                        </div>
                        <div class="chart-container"><canvas id="sector-chart-${h.symbol}"></canvas></div>
                        <div class="flip-hint"><i class="bi bi-arrow-repeat"></i> Tap to flip</div>
                    </div>
                    <div class="flip-card-back">
                        <div class="invest-bar" style="--invest-pct: ${barPct}%;"></div>
                        <div class="back-header">
                            <span class="back-title">${h.symbol}</span>
                            <span class="back-close"><i class="bi bi-arrow-repeat"></i></span>
                        </div>
                        <p class="text-secondary small">${h.description || 'Loading fundamentals...'}</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Load sparkline for sector view cards
    async function loadSectorSparkline(symbol, isProfit, isTrading = false) {
        try {
            let prices;
            let color;

            if (isTrading) {
                // In Trading mode, use intraday data
                prices = getCachedData(`intraday_${symbol}`);
                if (!prices) {
                    const response = await fetch(`/api/historical/${symbol}?period=1d&interval=5m`);
                    if (response.ok) {
                        const data = await response.json();
                        prices = data.prices || [];
                        if (prices.length > 0) {
                            setCachedData(`intraday_${symbol}`, prices, 5 * 60 * 1000);
                        }
                    }
                }
                // Color based on day performance (first vs last price)
                const dayProfit = prices && prices.length > 1 && prices[prices.length - 1] >= prices[0];
                color = dayProfit ? '#22c55e' : '#ef4444';
            } else {
                // In Holdings mode, use 1Y data
                prices = getCachedData(`hist_${symbol}`);
                if (!prices) {
                    const response = await fetch(`/api/historical/${symbol}?period=1y`);
                    if (response.ok) {
                        const data = await response.json();
                        prices = data.prices || [];
                        if (prices.length > 0) {
                            setCachedData(`hist_${symbol}`, prices);
                        }
                    }
                }
                color = isProfit ? '#22c55e' : '#ef4444';
            }

            if (!prices || prices.length === 0) return;

            const ctx = document.getElementById(`sector-chart-${symbol}`);
            if (!ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map((_, i) => i),
                    datasets: [{
                        data: prices,
                        borderColor: color,
                        borderWidth: 1.5,
                        fill: true,
                        backgroundColor: color + '15',
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        } catch (error) {
            // Silent fail for charts
        }
    }

    // Toggle sector collapse
    function toggleSector(header) {
        header.classList.toggle('collapsed');
        header.nextElementSibling.classList.toggle('collapsed');
    }

    // Sort button handlers
    document.querySelectorAll('.sort-btn[data-sort]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.sort-btn[data-sort]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSort = this.dataset.sort;
            // Re-render current view
            if (currentView === 'grid') {
                renderHoldingCards();
            } else if (currentView === 'list') {
                renderListView();
            } else if (currentView === 'sector') {
                renderSectorView();
            }
        });
    });

    // Toggle sort order - update for all views
    function toggleSortOrder() {
        sortAscending = !sortAscending;
        document.getElementById('sortOrder').innerHTML = `<i class="bi bi-sort-${sortAscending ? 'up' : 'down'}"></i>`;
        if (currentView === 'grid') {
            renderHoldingCards();
        } else if (currentView === 'list') {
            renderListView();
        } else if (currentView === 'sector') {
            renderSectorView();
        }
    }

    // Portfolio chart instance
    let portfolioChartInstance = null;

    // Show portfolio chart modal
    async function showPortfolioChart() {
        document.getElementById('portfolioChartModal').classList.add('active');
        await loadPortfolioChart();
    }

    // Close portfolio chart modal
    function closePortfolioChart(event) {
        if (!event || event.target === document.getElementById('portfolioChartModal')) {
            document.getElementById('portfolioChartModal').classList.remove('active');
        }
    }

    // Load portfolio comparison chart
    async function loadPortfolioChart() {
        try {
            // Fetch Nifty 50 data
            const niftyResponse = await fetch('/api/historical/NIFTY50?period=1y');
            let niftyData = [];
            if (niftyResponse.ok) {
                const data = await niftyResponse.json();
                niftyData = data.prices || [];
            }

            // Calculate portfolio returns using cached price data
            // Normalize both to percentage change from start
            let portfolioReturns = [];
            let niftyReturns = [];

            if (niftyData.length > 0) {
                const niftyBase = niftyData[0];
                niftyReturns = niftyData.map(p => ((p - niftyBase) / niftyBase * 100).toFixed(2));
            }

            // Get weighted portfolio returns based on holdings
            const totalInvested = holdingsData.reduce((sum, h) => sum + h.invested, 0);
            if (holdingsData.length > 0 && totalInvested > 0) {
                // Use first stock's historical data length as reference
                const refSymbol = holdingsData[0].symbol;
                let refPrices = getCachedData(`hist_${refSymbol}`) || [];

                for (let i = 0; i < refPrices.length; i++) {
                    let dayReturn = 0;
                    holdingsData.forEach(h => {
                        const prices = getCachedData(`hist_${h.symbol}`) || [];
                        if (prices.length > i && prices[0] > 0) {
                            const weight = h.invested / totalInvested;
                            const stockReturn = ((prices[i] - prices[0]) / prices[0]) * 100;
                            dayReturn += stockReturn * weight;
                        }
                    });
                    portfolioReturns.push(dayReturn.toFixed(2));
                }
            }

            // Create chart
            const ctx = document.getElementById('portfolioCompareChart');
            if (portfolioChartInstance) portfolioChartInstance.destroy();

            const labels = portfolioReturns.map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (portfolioReturns.length - i));
                return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
            });

            portfolioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio',
                        data: portfolioReturns,
                        borderColor: '#3b82f6',
                        borderWidth: 2.5,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }, {
                        label: 'Nifty 50',
                        data: niftyReturns.slice(0, portfolioReturns.length),
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#94a3b8',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const sign = context.raw >= 0 ? '+' : '';
                                    return `${context.dataset.label}: ${sign}${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#64748b', maxTicksLimit: 12 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: {
                                color: '#64748b',
                                callback: v => (v >= 0 ? '+' : '') + v + '%'
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading portfolio chart:', error);
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        const expandedOverlay = document.getElementById('expandedOverlay');
        const shareModal = document.getElementById('shareModal');

        // Only handle keys when expanded view is open and share modal is not
        if (!expandedOverlay.classList.contains('active')) return;
        if (shareModal.classList.contains('active')) return;

        switch(e.key) {
            case 'Escape':
                closeExpanded({ target: expandedOverlay });
                break;
            case 'ArrowLeft':
                navigateStock(-1);
                e.preventDefault();
                break;
            case 'ArrowRight':
                navigateStock(1);
                e.preventDefault();
                break;
        }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadHoldings();
        initSocketIO();  // Initialize Socket.IO for live price streaming
        initAutoRefresh();  // Fallback polling if socket fails
    });

    // =========================================================================
    // AI Chat Functions
    // =========================================================================

    let chatOpen = false;
    let chatLoading = false;

    function toggleChat() {
        const panel = document.getElementById('chatPanel');
        const fab = document.getElementById('chatFab');

        chatOpen = !chatOpen;

        if (chatOpen) {
            panel.classList.add('open');
            fab.classList.add('active');
            fab.innerHTML = '<i class="bi bi-x"></i>';
            loadChatSuggestions();
            document.getElementById('chatInput').focus();
        } else {
            panel.classList.remove('open');
            fab.classList.remove('active');
            fab.innerHTML = '<i class="bi bi-chat-dots"></i>';
        }
    }

    async function loadChatSuggestions() {
        try {
            const response = await fetch('/api/chat/suggestions');
            const data = await response.json();

            if (data.suggestions) {
                const container = document.getElementById('chatSuggestions');
                container.innerHTML = data.suggestions.slice(0, 4).map(s =>
                    `<button class="suggestion-chip" onclick="sendSuggestion('${s.replace(/'/g, "\\'")}')">${s}</button>`
                ).join('');
            }
        } catch (error) {
            console.error('Error loading suggestions:', error);
        }
    }

    function sendSuggestion(text) {
        document.getElementById('chatInput').value = text;
        sendChatMessage();
    }

    function handleChatKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendChatMessage();
        }
    }

    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message || chatLoading) return;

        // Add user message to chat
        addChatMessage(message, 'user');
        input.value = '';

        // Show typing indicator
        chatLoading = true;
        document.getElementById('chatSendBtn').disabled = true;
        const typingEl = addTypingIndicator();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await response.json();

            // Remove typing indicator
            typingEl.remove();

            if (data.error) {
                addChatMessage(data.error, 'error');
            } else {
                addChatMessage(data.response, 'assistant');
            }
        } catch (error) {
            typingEl.remove();
            addChatMessage('Failed to connect to AI service. Please try again.', 'error');
        } finally {
            chatLoading = false;
            document.getElementById('chatSendBtn').disabled = false;
        }
    }

    function addChatMessage(text, type) {
        const container = document.getElementById('chatMessages');

        const messageEl = document.createElement('div');
        messageEl.className = `chat-message ${type}`;

        // Format markdown-like content for assistant messages
        if (type === 'assistant') {
            messageEl.innerHTML = formatChatResponse(text);
        } else {
            messageEl.textContent = text;
        }

        container.appendChild(messageEl);
        container.scrollTop = container.scrollHeight;
    }

    function addTypingIndicator() {
        const container = document.getElementById('chatMessages');

        const typingEl = document.createElement('div');
        typingEl.className = 'chat-message assistant';
        typingEl.innerHTML = '<div class="chat-typing"><span></span><span></span><span></span></div>';

        container.appendChild(typingEl);
        container.scrollTop = container.scrollHeight;

        return typingEl;
    }

    function formatChatResponse(text) {
        // Convert markdown-like formatting
        let html = text
            // Code blocks
            .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            // Inline code
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            // Bold
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            // Line breaks
            .replace(/\n/g, '<br>')
            // Lists
            .replace(/^[-]\s+(.+)$/gm, '<li>$1</li>')
            // Currency formatting
            .replace(/([\d,]+\.?\d*)/g, '<span style="color:#22c55e;">$1</span>');

        return html;
    }

    async function clearChatHistory() {
        try {
            await fetch('/api/chat/clear', { method: 'POST' });

            // Clear messages in UI
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div class="chat-message assistant">
                    Chat history cleared. How can I help you?
                </div>
            `;
        } catch (error) {
            console.error('Error clearing chat:', error);
        }
    }
</script>
{% endblock %}
